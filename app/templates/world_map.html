{% extends "base.html" %}
{% block title %}Trend Analysis of Flickr Tags{% endblock %}
{% block body %}
    <head>
		
        <meta charset="utf-8">
 <!--       <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> -->
		<script type="text/javascript">
			d3.selectAll(".nav-item").classed("active", false);
			d3.select("#nav-link-map").classed("active", true);
		</script>
        <!-- <script type="text/javascript" src="psd3.js"></script> -->
        <!-- <link rel="stylesheet" type="text/css" href="psd3.css" /> -->
        <style>
            /* CSS goes here. */
			
			body {
				overflow-x: hidden; //horizontal
				overflow-y: hidden; //vertical
			}
			
			text {
				font-family: -apple-system, BlinkMacSystemFontsystem-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; 
				font-size: 12px;
			}
			
			#main-content-container {
				margin: 0;
				padding: 0;
			}
			
            .subunit {	
                fill: none;
                stroke: #FFF;
                stroke-width: 1px;
            }
            text.subunit-label {
                font-family: -apple-system, BlinkMacSystemFontsystem-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; 
                font-size: 14px;
                font-weight: 300;
                text-anchor: middle;
                fill: #000;
            }
            .subunit-label {
                display: none;
            }
            .graticule {
                fill: none;
                stroke: #aaa;
                stroke-opacity: .5;
                stroke-width: .5px;
            }

            .background {
            fill: none;
            pointer-events: all; 
            }

            .feature {
            fill: #ccc;
            cursor: pointer;
            }

            .feature.active {
            fill: orange;
            }

            .mesh {
            fill: none;
            stroke: #fff;
            stroke-linecap: round;
            stroke-linejoin: round;
            }

            .rect {
                border-radius: 3px;
            }







            #container {
				height: 400px; 
			}

			.highcharts-figure, .highcharts-data-table table {
				min-width: 320px; 
				max-width: 800px;
				margin: 1em auto;
			}

			.highcharts-data-table table {
				font-family: Verdana, sans-serif;
				border-collapse: collapse;
				border: 1px solid #EBEBEB;
				margin: 10px auto;
				text-align: center;
				width: 100%;
				max-width: 500px;
			}
			.highcharts-data-table caption {
				padding: 1em 0;
				font-size: 1.2em;
				color: #555;
			}
			.highcharts-data-table th {
				font-weight: 600;
				padding: 0.5em;
			}
			.highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
				padding: 0.5em;
			}
			.highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
				background: #f8f8f8;
			}
			.highcharts-data-table tr:hover {
				background: #f1f7ff;
			}
			.slider{
				width: 800px;
			}



		/* CSS for tabs */


		#exTab1 .tab-content {
		  color : white;
		  background-color: #428bca;
		  padding : 5px 15px;
		}

		#exTab2 h3 {
		  background-color: white;
		  padding : 5px 15px;
		}

		/* remove border radius for the tab */

		#exTab1 .nav-pills > li > a {
		  border-radius: 0;
		}

		/* change border radius for the tab , apply corners on top*/

		#exTab3 .nav-pills > li > a {
		  border-radius: 4px 4px 0 0 ;
		}

		#exTab3 .tab-content {
		  color : white;
		  background-color: #428bca;
		  padding : 5px 15px;
		}

		path:hover
		{
			fill-opacity: .5;
		}
		  
		.axis path {
		  fill: none;
		}
		  
		.axis line {
		  fill: none;
		  stroke: rgba(0, 0, 0, 0.5);
		}
		  
		.background
		{
			fill: transparent;
			pointer-events: all;
		}

		.legend
		{
			position:absolute;
			left:20px;
			top:30px;
		}

		  
		.d3-tip
		{
			line-height: 1;
			width: 328px;
			height: fit-content;
			padding: 12px;
			/*background: rgba(204, 188, 188, 0.836)*/
			background-color: lavender;
			color: black;
			border-radius: 2px;
		}

		.d3-tip:after
		{
			box-sizing: border-box;
			width: 328px;
			height: fit-content;
			font-size: 5px;
			line-height: 1;
			/*color: rgba(204, 188, 188, 0.836);*/
			content: "\25BC";
			position: absolute;
			text-align: center;
		}

		.d3-tip.n:after
		{
			margin: -1px 0 0 0;
			width: 328px;
			height: fit-content;
			top: 100%;
			left: 0;
		}
		  
		#tipDiv
		{
			width: 150px;
			background-opacity: 0;
		}

		#tipDiv2
		{
			width: 150px;
			background-opacity: 0;
		}

		#button {
		  background: #ccc;
		  cursor: pointer;
		  border-top: solid 2px #eaeaea;
		  border-left: solid 2px #eaeaea;
		  border-bottom: solid 2px #777;
		  border-right: solid 2px #777;
		  padding: 5px 5px;
		}

		#button.down {
		  background: #bbb;
		  border-top: solid 2px #777;
		  border-left: solid 2px #777;
		  border-bottom: solid 2px #eaeaea;
		  border-right: solid 2px #eaeaea;
		}


		.arc text {
		  font: 10px sans-serif;
		  text-anchor: middle;
		}

		.arc path {
		  stroke: #000000;
		}

		.toolTip {
    position: absolute;
    display: none;
    width: auto;
    height: auto;
    background: none repeat scroll 0 0 white;
    border: 0 none;
    border-radius: 8px 8px 8px 8px;
    box-shadow: -3px 3px 15px #888888;
    color: black;
    font: 12px sans-serif;
    padding: 5px;
    text-align: center;
}

		#background-left {
			fill-opacity: 0.7;
			stroke: lightgray;
		}
		#background-right		{
			fill-opacity: 0.7;
			stroke: lightgray;
		}
		
		#background-stream {
			fill: rgb(245, 245, 245);
			fill-opacity: 0.7;
			stroke: lightgray;
		}
		
		
		
		.shadow {
			-webkit-filter: drop-shadow( 3px 3px 2px rgba(0, 0, 0, .7));
			filter: drop-shadow( 3px 3px 2px rgba(0, 0, 0, .7));
			/* Similar syntax to box-shadow */
		}
		
		
		#focus-grab {
			fill: rgba(115,115,115,0.9);
			border-radius:2px;
			border-color: gray;
			rx: 2;
			ry: 2;
			 -webkit-box-shadow:1px 1px 8px rgba(0,0,0,0.3);
			-moz-box-shadow:   1px 1px 8px rgba(0,0,0,0.3);
			box-shadow:        1px 1px 8px rgba(0,0,0,0.3);
			cursor: pointer;
		}


		
		#focus-grab-text {
			font-family: 'Anonymous Pro', sans-serif;
			fill: white;
  			cursor: pointer;
			font-size: 0.8rem;
			line-height: 20px;
			color: rgba(0,0,0,0.5);
			text-decoration: none;
			letter-spacing: 3px;
			text-shadow:1px 1px 1px rgba(255,255,255,0.5);
			-webkit-box-shadow:1px 1px 8px rgba(0,0,0,0.3);
			-moz-box-shadow:   1px 1px 8px rgba(0,0,0,0.3);
			box-shadow:        1px 1px 8px rgba(0,0,0,0.3);

		}
		
		
		#button-wrapper {
		position: absolute;
		}
		
		button {
			width: 50px;
		}
		
		.play {
			font-family: 'Anonymous Pro', sans-serif;
			text-align: center;
			color: rgb(192,192,192);
			cursor: pointer;
			text-shadow:1px 1px 2px rgba(255,255,255,1);
			font-size: 0.8rem;
			line-height: 10px;
			color: rgba(0,0,0,0.5);
			text-decoration: none;
			text-shadow:1px 1px 2px rgba(255,255,255,1);
			-webkit-box-shadow:1px 1px 8px rgba(0,0,0,0.3);
			-moz-box-shadow:   1px 1px 8px rgba(0,0,0,0.3);
			box-shadow:        1px 1px 8px rgba(0,0,0,0.3);
		
		}
		
	
	svg#legend {
		position: absolute;
		-webkit-transform: translateX(-50%);
		-ms-transform: translateX(-50%);
		transform: translateX(-50%);
		display:inline-block;
	}

    svg#donutLegend {
	position: absolute;
	bottom: 0%;
	}
	
	svg#donutLegend2 {
	position: absolute;
	bottom: 0%;
	}

	#filter-options {
	position:absolute;
	left: 62%;
	top: 1%
	}
	
	#d3-tip {
			background: rgb(245, 245, 245);
			background-opacity: 0.7;
			opacity: 0.8;
			font-size: 12px;
			border-radius: 5px;
			border: 1.2px solid #b0b0b0;
	}
	
	#side-panel-country{
	padding-top: 50px;
	margin-top: 60px;
	margin-left: 10px;
	font-size: 20px;
	fill:#404040;  
	text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
	}
	
	text.graph_title_panel {
		font-family: -apple-system, BlinkMacSystemFontsystem-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; 
		fill:#2e2e2e;
		text-shadow: 0 0.5px 0 #fff, 0.5px 0 0 #fff, 0 -0.5px 0 #fff, -0.5px 0 0 #fff;
		font-size:14px;
}	

	p {
		font-family: -apple-system, BlinkMacSystemFontsystem-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; 
		fill:#2e2e2e;
		text-shadow: 0 0.5px 0 #fff, 0.5px 0 0 #fff, 0 -0.5px 0 #fff, -0.5px 0 0 #fff;
		font-size:14px;
}	

	#close_text {
	stroke: white;
	font-size: 8px;
	text-anchor: end;
	cursor: pointer;
}

	#g-focus-left {
	color: black;
}

	#stream-tooltip {
		fill:#2e2e2e;
		text-shadow: 0 0.5px 0 #fff, 0.5px 0 0 #fff, 0 -0.5px 0 #fff, -0.5px 0 0 #fff;
	}
	
	#tooltip-text {
		fill:#2e2e2e;
		text-shadow: 0 0.5px 0 #fff, 0.5px 0 0 #fff, 0 -0.5px 0 #fff, -0.5px 0 0 #fff;
	}
	
	#rect-grab {
	cursor: pointer;
	}
	
	#1tipDiv {
		background: red;
	}

	
	#tipdiv-div {
	
	font-size: 12px;
	
	}
	
	#1tipDiv2 {
		padding-left: 20px;
		padding-top: 5px;
	}
	
	</style>
    </head>
    <body>

        <script src="//d3js.org/topojson.v1.min.js"></script>
        <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src=".https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://code.highcharts.com/highcharts.js"></script>   
        <script src="https://code.highcharts.com/highcharts-more.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>   
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
        <script src="https://code.highcharts.com/modules/accessibility.js"></script>
        <script src="https://code.highcharts.com/modules/no-data-to-display.js"></script>

        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>

        <script src="../static/js/streamgraph.js" ></script>


        <div>
      
            <span>

                <div id="tooltip-holder"></div>
                <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

                <!-- Create a div where the graph will take place -->
                
				<div  id="button-wrapper" >
				<button name="play" id="play" class="play" style="height: 30px;">Play</button>
                </div>
                <div id="filter-options">

                    <input type="text" id="filterInput" name="filterInput" class="play" style="height: 30px;">
                    <button name="filterButton" id="filterButton" class="play" style="height: 30px;">Filter</button>
                    <button name="filterResetButton" id="filterResetButton" class="play" style="height: 30px;">Reset</button>

                </div>
            
				<div>
                    <svg id="legend" height=50 width=300></svg>
                </div>
                <div>
                    <svg id="donutLegend" height=50 width=300></svg>
                </div>

                <div id="my_dataviz"></div>
                <div style='position: absolute;
                top: 8%;
                pointer-events: none;
                box-sizing: border-box;
                left: 2%;' class="t1">
                    <!-- <strong>Most popular category: &nbsp;</strong><span id="popcat1"></span><br>
                    <strong>No. of images: &nbsp;</strong><span id="imageno1"></span><br><br> -->
                    <div style='display: -webkit-inline-box;'><div id='1tipDiv'></div><div id='1tipDiv2'><div style='text-align: center;'><p>Top tags</p></div><svg id='svgPie1'></svg></div></div>
                </div>
                <div style='position: absolute;
                top: 8%;
                pointer-events: none;
                box-sizing: border-box;
                left: 122%;' class="t2">
                    <!-- <strong>Most popular category: &nbsp;</strong><span id="popcat2"></span><br>
                    <strong>No. of images: &nbsp;</strong><span id="imageno2"></span><br><br> -->
                    <div style='display: -webkit-inline-box;'><div id='2tipDiv'></div><div id='2tipDiv2'><div style='text-align: center;'><p>Top tags</p></div><svg id='svgPie2'></svg></div></div>
                </div>
                


              
        
            </span>

            <!-- <div id="chartContainer" class="well"></div> -->
            <!-- <span class="chart-parent"><div id="chart"></div></span> -->

        </div>


        <script>

            /* JavaScript goes here. */
            // globals used in graph
            var running = false;
            var dataset = {};
            var tooltipDisabled = false;
            var timer;
            //var validTimeSteps = ["2007_12", "2008_01", "2008_02", "2008_03", "2008_04", "2008_05", "2008_06", "2008_07", "2008_08", "2008_09", "2008_10", "2008_11", "2008_12"]
            var validTimeSteps = ["2004_1", "2004_2", "2004_3", "2004_4", "2005_1", "2005_2", "2005_3", "2005_4", "2006_1", "2006_2", "2006_3", "2006_4", "2007_1", "2007_2", "2007_3", "2007_4", "2008_1", "2008_2", "2008_3", "2008_4", "2009_1", "2009_2"]
            var validYears = ["2004","2005","2006","2007","2008","2009"];

            var div = d3.select("body").append("div").attr("class", "toolTip");
            var catColor = [];
            catColor["camera"] = "#a6cee3";
            catColor["unknown"] = "#9c9c9c";
            catColor["phone"] = "#fb9a99";

            var mapdata = {};
            var popular_tags = true;

            var selectedColor = "lightgrey"
            var selectionColor = "white"


            var width_main = window.innerWidth -18
			
			var height_main = window.innerHeight -56

            var width = 0.6*width_main, height = 0.75*height_main;
			
            var width_side_panel = 0.2*width_main
            var current_position;
            var filterString = null
            var filterCategory = "animal"

            var sliderGPosX = 0

            // d3.select(".tip1")
            //     .style("left",0.2*height_main)
            //     .attr("top",0.15*width_side_panel);


            $(document).ready(function() {
                $('a#button').click(function() {
                    $(this).toggleClass("down");
                    popular_tags = !popular_tags;
                });
            });

            // define the tooltip 
            // var tool_tip = d3.tip()
            //     .attr("class", "d3-tip")
            //     // if the mouse position is greater than 650 (~ Kentucky/Missouri), offset tooltip to the left instead of the right
            //     .offset(function() {if(current_position[0] > 650) {
  	        //             return [-20,-120] } 
  	        //         else { return [20,120]}
            //     })
            //     // input the title, and include the div
            //     .html(
  	        //         "<p>Opioid-involved deaths over time in</p><div id='tipDiv'></div>"
            //     );
            var tip = d3.tip()
                .attr("class", "d3-tip")
                .attr("id", "d3-tip")
                .style("width", "350 px")
			    // .offset([0, -200])
    	        .html(function(d)
			    {
                    // var x = +d.properties.value;
                    // x = x.toPrecision(2);
                    return "<strong>Country: &nbsp;</strong><span>" + d.properties.name + "<br></span>"
                        + "<strong>Most popular category: &nbsp;</strong><span>" + d.properties.most_popular_tag + "<br></span>"
                        + "<strong>No. of images: &nbsp;</strong><span>" + d.properties.user_freq + "<br><br></span>"
                        + "<div style='display: inline-flex;'><div id='tipDiv'></div><div id='tipDiv2'><div style='text-align: center;'><h5>Top tags</h5></div><svg id='my_dataviz2'></svg></div></div>";
                });
            
            
            
            active = d3.select(null);
            var zoom = d3.zoom()            
            // no longer in d3 v4 - zoom initialises with zoomIdentity, so it's already at origin
            // .translate([0, 0]) 
            // .scale(1) 
            .scaleExtent([1, 8])
            .on("zoom", zoomed);
            var minDocCount = 0, quantiles = {};
            // projection definitions
            var projection = d3.geoMercator()
                .scale((width + 1) / 2 / Math.PI)
                .translate([width/2, (height/2)+height_main*0.2])
                .precision(.1);
            var path = d3.geoPath().projection(projection);
            // SVG related definitions

            var main_container = d3.select("#my_dataviz").append("svg").attr("id", "main_container")
                        .attr("height", height_main)    // set the height
                        .attr("width", width_main); 

            var svg = main_container.append("g")
                        .attr("height", height)    // set the height
                        .attr("width", width)
                        .attr("id", "map-container")
                        .attr("transform",
                            "translate(" + width_side_panel + "," + 0 + ")");
            var left_panel =  main_container.append("g")
                        .attr("height", height_main)    // set the height
                        .attr("width", width_side_panel)
                        .attr("id", "left_panel")
                        .attr("fill", selectionColor)

            var rightPanelOffset = width_main - width_side_panel
            var right_panel =  main_container.append("g")
                        .attr("height", height_main)    // set the height
                        .attr("width", width_side_panel)
                        .attr("id", "right_panel")
                        .attr("fill", selectedColor)
                        .attr("transform",
                            "translate(" + rightPanelOffset + "," + 0 + ")");
            
            left_panel
                .append("rect")
                .attr("id", "background-left")
				.attr("class", "shadow" )
                .attr("width", width_side_panel)
                .attr("height", height_main)
            right_panel
                .append("rect")
                .attr("id", "background-right")
				.attr("class", "shadow" )
                .attr("width", width_side_panel)
                .attr("height", height_main)
			
            svg.call(tip);
            
            svg.append("rect")
                .attr("class", "background")
                .attr("width", width)
                .attr("height", height)

                .on("click", reset);
            var g = svg.append("g");

            svg
                .call(zoom); // delete this line to disable free zooming

            var filter = svg.append('defs')
                .append('filter')
                .attr("height", 1)    // set the height
                .attr("width", 1)    // set the width
                .attr("x", 0)    
                .attr("y", 0)    
                .attr("id", 'gray-background')
            filter.append('feFlood')
                .attr('flood-color', '#f2f2f2')
                .attr('result', 'COLOR');
            filter.append('feMorphology')
                .attr('operator', 'dilate')
                .attr('radius', '.9')
                .attr('in', 'SourceAlpha')
                .attr('result', 'MORPHED');
            filter.append('feComposite')
                .attr('in', 'SourceGraphic')
                .attr('in2', 'MORPHED')
                .attr('result', 'COMP1');
            filter.append('feComposite')
                .attr('in', 'COMP1')
                .attr('in2', 'COLOR');

            


            /// getting json input from flask
            var countries_mock_data = {{countries_mock_data| tojson}}
            var world_countries = {{ world_countries | tojson}};
            /*
            /// ALL data from csv
            var csv_data_all = {{ csv_data | tojson}};

            /// Object for filtering
            var filterObjectMap = 
            {
                "date":"2008_11"
            }

            console.log(csv_data_all)
            filtered_data = _.filter(csv_data_all, filterObjectMap)
            console.log("filtered")
            console.log(filtered_data)
            */

            var allTags = []
            for(catInd in Object.keys(countries_mock_data.allCategories))

            var myColor = d3.scaleOrdinal().domain(countries_mock_data.allCategories)
                .range(['#ffff99', '#beaed4' , '#7fc97f', '#fdc086', '#f0027f', '#386cb0', '#D3D3D3']);
			// animal, citylife, nature, people, sports, unknown
			
            //console.log(countries_mock_data)
            current_date_ind = 0
            current_date = validTimeSteps[current_date_ind]
            current_year_data = countries_mock_data.timesteps[current_date]
            country_in_focus_1 = "WORLD"
            country_in_focus_2 = "WORLD"
            //console.log(current_year_data)
            

            draw(world_countries ,current_year_data)

            function get_most_popular(obj){
                maxTag = -10000
                tag = ""
                for(ind in Object.keys(obj)){
                    key = Object.keys(obj)[ind]
                    if(obj[key]>maxTag){
                        maxTag = obj[key]
                        tag = key
                    }
                }
                return tag
            }

            function draw(world, data) {

                    for(var idx=0; idx < data.country_data.buckets.length; idx++) {
                        var cCode = data.country_data.buckets[idx].key.toUpperCase();
                        var most_popular_tag = data.country_data.buckets[idx].most_popular_category;
                        var most_popular_taglist = data.country_data.buckets[idx].categories_sum;
                        var user_freq = data.country_data.buckets[idx].user_freq;
                        var device_data = data.country_data.buckets[idx].device_data;
                        var catTrend = data.country_data.buckets[idx].categories;
                        for(var wdx=0; wdx < world.objects.subunits.geometries.length; wdx++) {
                            var cName = world.objects.subunits.geometries[wdx].id.toUpperCase();
                            if (cCode === cName) {
                                //TODO is it really necessary to take the data for charts from the map data?? 
                                // can also get it from an external json file using the country id... 
                                world.objects.subunits.geometries[wdx].properties.most_popular_tag = most_popular_tag;
                                world.objects.subunits.geometries[wdx].properties.most_popular_5 = most_popular_taglist;
                                world.objects.subunits.geometries[wdx].properties.user_freq = user_freq;
                                world.objects.subunits.geometries[wdx].properties.device_data = device_data;
                                world.objects.subunits.geometries[wdx].properties.category_trend = catTrend;
                            }
                        }
                    }
                    var subunits = topojson.feature(world, world.objects.subunits);
                    subunits.features = subunits.features.filter(function(d){ return d.id !== "ATA"; });
                    minDocCount = d3.min(subunits.features, function(d){ return d.properties.most_popular_tag; });
                    var most_popular_tag = subunits.features.map(function(d){ return d.properties.most_popular_tag; });
                    most_popular_tag = most_popular_tag.filter(function(d){ return d; }).sort(d3.ascending);

                    
                    //console.log('most_popular_tag',most_popular_tag);
                    quantiles['0.95'] = d3.quantile(most_popular_tag, '0.95');
                    var countries = g.selectAll('path.subunit')
                        .data(subunits.features).enter();

                    countries.insert('path', '.graticule')
                        .attr('class', function(d) { return 'subunit ca'+d.id; })
                        .attr('d', path)
                        .on('mouseover',mouseoverLegend).on('mouseout',mouseoutLegend)
                        .on('mousemove',mouseMoveFunction)
                        .on("click", clicked);
                    
                    countries.append('svg:text')
                        .attr('class', function(d){ return 'subunit-label la'+d.id+d.properties.name.replace(/[ \.#']+/g,''); })
                        //.attr('transform', function(d) { return 'translate('+ path.centroid(d) +')'; })
                        .attr('transform', function(d) { return 'translate('+(width-(5*d.properties.name.length))+','+(15)+')'; })
                        .attr('dy', '.35em')
                        .attr('filter', 'url(#gray-background)')
                        .append('svg:tspan')
                        .attr('x', 0)
                        .attr('dy', 0)
                        .text(function(d) { return d.properties.name; })
                        .append('svg:tspan')
                        .attr('x', 0)
                        .attr('dy', 20)
                        .text(function(d) { return d.properties.most_popular_tag ? d.properties.most_popular_tag : ''; });
                    
                    var toColor = g.selectAll(".subunit")

                    toColor            
                    .transition()
                    .duration(750)
                    .style("fill", heatColor)

             
            }

            function mouseMoveFunction(datum, index) {
                // tip.style("left", d3.select(this).attr("cx") + "px")     
                //     .style("top", d3.select(this).attr("cy") + "px");
                if (!tooltipDisabled) {
                    tip.show(datum);
                    tip.style("left", d3.event.pageX+10+"px");
                    tip.style("top", d3.event.pageY-25+"px");
                    tip.style("display", "inline-block");
                    //tip.show(datum);
                }
               
                if (popular_tags) {
                    refreshPie1(datum);
                    refreshTopTags(datum);
                }
            }
            

            function mouseoverLegend(datum, index) {
                var point = d3.mouse(this);
                current_position = point;
                d3.selectAll('.subunit-label.la'+datum.id+datum.properties.name.replace(/[ \.#']+/g,''))
                    .style('display', 'inline-block')
              
                d3.selectAll('.subunit.ca'+datum.id)
                    .style("fill", function() {
					return d3.rgb(d3.select(this).style("fill")).darker(0.5);
					});


                //tooltip.style("opacity", 1);
                //tooltip.style("transform", `translate(50px,50px)`)
                // tip.show(datum);
                // refreshDonut1(datum);
                // //TODO Need to add null checks..
                // var tip_country = datum.properties.name;
                // var tip_most_popular_tag = datum.properties.most_popular_tag;
                // var tip_user_freq = datum.properties.user_freq;


                // var tipSVG = d3.select("#tipDiv")
      			// 	.append("svg")
      			// 	.attr("width", 150)
                //     .attr("height", 20);

                
                      
            
                
            } 

            function mouseoutLegend(datum, index) {
                d3.selectAll('.subunit-label.la'+datum.id+datum.properties.name.replace(/[ \.#']+/g,''))
                    .style('display', 'none');
                d3.selectAll('.subunit.ca'+datum.id)
                    .style('fill', heatColor(datum));

                //tooltip.style("opacity", 0)
                //tip.hide();
                tip.style("display", "none");
            }


            function heatColor(d) {
                d_c = d.properties.most_popular_tag
                return d_c === null ? 'grey' :myColor(d_c);
            }
            /////////////////////////////////////////////////////// Zooming functions //////////////////////////////////////////////////////
            function clicked(d) {
                if (active.node() === this) {
                    return reset();
                }
                active.classed("active", false);
                //tooltipDisabled = true;
                active = d3.select(this).classed("active", true);
                d3.select("#d3-tip").attr("disabled", true);

                var bounds = path.bounds(d),
                    dx = bounds[1][0] - bounds[0][0],
                    dy = bounds[1][1] - bounds[0][1],
                    x = (bounds[0][0] + bounds[1][0]) / 2,
                    y = (bounds[0][1] + bounds[1][1]) / 2,
                    scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
                    translate = [width / 2 - scale * x, height / 2 - scale * y];
                svg.transition()
                    .duration(2000)
                    // .call(zoom.translate(translate).scale(scale).event); // not in d3 v4
                    .call( zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) ); // updated for d3 v4
                
                //refreshDonutDiv(d);
                //refreshPieDiv(d);
                
                
                
                //refreshCategoryDonut(d.id, dataset)
                changeCurrentSelections(d.id, d.properties.name)
                updatePanelCountry()
                if (current_selection_svg == svg_stream) {
                    refreshStreamGraph(d.id, current_selection_svg, validTimeSteps, width_stream, height_stream, "category", current_selection_ticks_enabled)
                    refreshStreamGraph(d.id, svg_focused_stream, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                    updatedMultiDonutRight(d.id, getFocusedValidSteps());
                    refreshSidePanelPie2(d);
                    refreshSidePanelTopTags2(d);
                } else {
                    refreshStreamGraph(d.id, current_selection_svg, validTimeSteps, width_stream, height_stream, "category", current_selection_ticks_enabled)
                    refreshStreamGraph(d.id, svg_focused_stream, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                    updatedMultiDonut(d.id, getFocusedValidSteps());
                    refreshSidePanelPie1(d);
                    refreshSidePanelTopTags1(d);
                }
                

            }

            function reset() {
                active.classed("active", false);
                //tooltipDisabled = false;
                //d3.select("#d3-tip").attr("disabled", false);
                active = d3.select(null);

                svg.transition()
                    .duration(750)
                    // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
                    .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4

                
                
                if(current_selection_svg == svg_stream){
                    country_in_focus_2 = "WORLD"
                    refreshStreamGraph("WORLD", prev_selection_svg, validTimeSteps, width_stream, height_stream, "category", current_selection_ticks_enabled)
                    refreshStreamGraph("WORLD", prev_svg_focused_stream, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                    updatedMultiDonutRight("WORLD", getFocusedValidSteps());
                    refreshSidePanelPie2("WORLD");
                    refreshSidePanelTopTags2("WORLD");
                }else{
                    country_in_focus_1 = "WORLD"
                    refreshStreamGraph("WORLD", prev_selection_svg, validTimeSteps, width_stream, height_stream, "category", current_selection_ticks_enabled)
                    refreshStreamGraph("WORLD", prev_svg_focused_stream, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                    updatedMultiDonut("WORLD", getFocusedValidSteps());
                    refreshSidePanelPie1("WORLD");
                    refreshSidePanelTopTags1("WORLD");
                }
                updatePanelCountry();
                
                
                //refreshCategoryDonut("WORLD",dataset);
                //TODO have to add reset functionality for pie and donut..

            }

            function zoomed() {
                g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
                // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
                g.attr("transform", d3.event.transform); // updated for d3 v4
            }

            // If the drag behavior prevents the default click,
            // also stop propagation so we donâ€™t click-to-zoom.
            function stopped() {
                if (d3.event.defaultPrevented) d3.event.stopPropagation();
            }

            ///////////////////////////////////////////////// Play button functions /////////////////////////////////////////////////////////////////////
            // heat point test

            // add circles to svg
            /*
            g.selectAll("circle")
                .data(testpoints).enter()
                .append("circle")
                .attr("cx", function (d) { console.log(projection(d)); return projection(d)[0]; })
                .attr("cy", function (d) { return projection(d)[1]; })
                .attr("r", "5px")
                .attr("fill", "grey")
                .attr("fill-opacity","0.2")
            */
            function getFilterCategory(){
                if(reverseTagCatIndex[filterString]){
                    filterCategory = reverseTagCatIndex[filterString]
                    return
                }
                Object.keys(countries_mock_data.timesteps).forEach((ts, ts_ind) => {
                    ts_obj = countries_mock_data.timesteps[ts]

                    ts_obj.country_data.buckets.forEach((countrydata, countryInd) => {

                        Object.keys(countrydata.categories).forEach((cat, catind) => {
                            catObj = countrydata.categories[cat]
                            Object.keys(catObj.all_tags).forEach((key, keyInd) => {
                                
                                if(key == filterString){
                             
                                    filterCategory =  cat
                                    return
                                }
                            })
                        })
                    })
                })


            }

            function filterTagsByString(){
                filterString = document.getElementById("filterInput").value
                getFilterCategory()
    
                refreshStreamGraph(country_in_focus_1, left_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                refreshStreamGraph(country_in_focus_2, right_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")

                refreshStreamGraph(country_in_focus_1, svg_stream, validTimeSteps, width_stream, height_stream, "category", false)
                refreshStreamGraph(country_in_focus_2, svg_stream_2, validTimeSteps, width_stream, height_stream, "category", true)
            
            }

            $("#filterButton").on("click", function() {
                
                filterTagsByString()
                
            } )

            $("#filterResetButton").on("click", function() {
		
            document.getElementById("filterInput").value = ""
            filterString = null
            refreshStreamGraph(country_in_focus_1, left_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
            refreshStreamGraph(country_in_focus_2, right_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")

            refreshStreamGraph(country_in_focus_1, svg_stream, validTimeSteps, width_stream, height_stream, "category", false)
            refreshStreamGraph(country_in_focus_2, svg_stream_2, validTimeSteps, width_stream, height_stream, "category", true)

            
			
            
                
            } )
            
            $("#play").on("click", function() {
		
            var duration = 800,
                maxstep = validTimeSteps[validTimeSteps.length],
                minstep = validTimeSteps[0];
            
            if (running == true) {
            
                $("#play").html("Play");
                running = false;
                clearInterval(timer);
                
            } 
 
            else if (running == false) {
            
                $("#play").html("Pause");
                
                
                timer = setInterval( function(){
                        if (current_date != maxstep){
                            current_date_ind++;
                            current_date = validTimeSteps	[current_date_ind]
                            current_year_data = countries_mock_data.timesteps[current_date]
                          
                            draw(world_countries,current_year_data);
                            updateStreamSlider()
                        }else{
                            $("#play").html("Play");
                            running = false;
                            clearInterval(timer);
                        }
            
                    
                }, duration);
                running = true;
                
                
            }

        });
        ////////////////////////////////// StreamGraph ///////////////////////////////////////////////////////////////////////////////////////////////////
            
            var allCategoriesEmpyty = {
            }
            for(catInd in countries_mock_data.allCategories){
                allCategoriesEmpyty[countries_mock_data.allCategories[catInd]] = 0
            }
            var allTagsEmpyty = {}
            var reverseTagCatIndex = {}


    

    var margin = {top: 60, right: 20, bottom: 5, left: 20},
    width_stream = width_main *0.5
    height_stream = 70

    


d3.select("#main_container")
    .append("g")
        .attr("width", width_stream  + margin.left + margin.right)
        .attr("height", height_stream * 2.5 + margin.top)
        .attr("id", "streamContainer")
        .attr("transform",
            "translate(" + width_side_panel + "," + -10 + ")")
    
    d3.select("#streamContainer")
        .append("rect")
        .attr("id", "background-stream")
        .attr("width", width_stream *1.1 + margin.left + margin.right)
        .attr("height", height_stream * 2.5 + margin.top)
        .attr("transform",
            "translate(" + margin.left + "," + (height-10) + ")")
	
	d3.select("#button-wrapper")
		.style("bottom", 40 +"px")
		.style("left", width_side_panel +3*margin.left + "px")

    svg_stream = d3.selectAll("#streamContainer")
        .append("g")
        .attr("transform",
            "translate(" + (margin.left*3.5) + "," + (height+10 ) + ")")
        .attr("id", "stream_1")
		
	svg_stream
		.append("text")
		.text("Trend of images per category")
		.attr("class", "graph_title_panel")
        .attr("transform",
            "translate(" + margin.left*6+ "," + (height_stream * 2.5 ) + ")")

		

    var selected_indicator = d3.selectAll("#streamContainer")
        .append("rect")
        .attr("id", "selected-ind")
        .style("fill", selectedColor)
        .attr("rx", 3)
        .attr("ry", 3)
        .style("stroke", "gray")
        .attr("width", 50)
        .attr("height", 10)
        .attr("x", width_stream + margin.left*4)
        .attr("y",   (height+height_stream+(height_stream/2) +3 ));

    var selected_indicator_text = d3.selectAll("#streamContainer")

        .append("text")
		.attr("id", "selected-ind-text")
        .attr("x", width_stream + margin.left*4)
        .attr("y",   (height+height_stream+(height_stream/2) ))
        .text("Selected")

    var selection_indicator = d3.selectAll("#streamContainer")
        .append("rect")
        .attr("id", "selection-ind")
        .style("fill", selectionColor)
        .attr("rx", 3)
        .attr("ry", 3)
        .style("stroke", "gray")
        .attr("width", 50)
        .attr("height", 10)
        .attr("x", width_stream + margin.left*4)
        .attr("y",   (height+(height_stream/2) +3));

    var selection_indicator_text = d3.selectAll("#streamContainer")

        .append("text")
		.attr("id", "selection-ind-text")
        .attr("x", width_stream + margin.left*4)
        .attr("y",   (height+(height_stream/2) ))
        .text("Selecting")
    
	
    height_stream_2 = height_stream
    var offset_top_stream_2 = (height+margin.top)
    var svg_stream_2 = d3.selectAll("#streamContainer")
            .append("g")
            .attr("transform",
                    "translate(" + (margin.left*3.5) + "," + (offset_top_stream_2 +15)+ ")")
            .attr("id", "stream_2");

    current_selection_svg = svg_stream
    prev_selection_svg = svg_stream_2
    current_selection_ticks_enabled = false

    function resetSideBar(side){
        if(side == "left"){
            country_in_focus_1 = "WORLD"
            refreshStreamGraph(country_in_focus_1, svg_stream, validTimeSteps, width_stream, height_stream, "category", false)
            refreshStreamGraph(country_in_focus_1, left_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
            if(current_selection_svg == svg_stream_2){
                changeCurrentSelections();
                refreshSidePanelPie1(country_in_focus_1);
                refreshSidePanelTopTags1(country_in_focus_1);
                updatedMultiDonut(country_in_focus_1, getFocusedValidSteps());
            }
            
        }else{
            country_in_focus_2 = "WORLD"
            refreshStreamGraph(country_in_focus_2, svg_stream_2, validTimeSteps, width_stream, height_stream, "category", true)
            refreshStreamGraph(country_in_focus_2, right_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
            if(current_selection_svg == svg_stream){
                changeCurrentSelections();
                refreshSidePanelPie2(country_in_focus_2);
                refreshSidePanelTopTags2(country_in_focus_2);
                updatedMultiDonutRight(country_in_focus_2, getFocusedValidSteps());
            }
        }
        svg.transition()
                    .duration(750)
                    // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
                    .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4
        updatePanelCountry()
    }
    
    function changeCurrentSelections(countryID, countryname){
        if(current_selection_svg == svg_stream){
            current_selection_svg = svg_stream_2
            prev_selection_svg = svg_stream
            svg_focused_stream = right_focus_g
            prev_svg_focused_stream = left_focus_g
            current_selection_ticks_enabled = true
            country_in_focus_1 = countryID
			country_name_1 = countryname
            selected_ind_height = height  + height_stream/2
            selection_ind_height = height + height_stream + height_stream/2 -3
            leftColor = selectedColor
            rightColor = selectionColor
        }else{
            current_selection_svg = svg_stream
            svg_focused_stream = left_focus_g
            prev_selection_svg = svg_stream_2
            prev_svg_focused_stream = right_focus_g
            current_selection_ticks_enabled = false
            country_in_focus_2 = countryID
			country_name_2 = countryname
            selected_ind_height = height + height_stream +  height_stream/2
            selection_ind_height = height + height_stream/2 
            leftColor = selectionColor
            rightColor = selectedColor
        }
        d3.selectAll("#selection-ind").transition().duration(750).attr("y", selection_ind_height+3)
        d3.selectAll("#selected-ind").transition().duration(750).attr("y", selected_ind_height+3)

        d3.selectAll("#selection-ind-text").transition().duration(750).attr("y", selection_ind_height)
        d3.selectAll("#selected-ind-text").transition().duration(750).attr("y", selected_ind_height)

        d3.selectAll("#background-left").transition().duration(750).attr("fill", leftColor)
        d3.selectAll("#background-right").transition().duration(750).attr("fill", rightColor)
    }

    function updatePanelCountry(){
        d3.selectAll("#side-panel-country")
		  .remove()
		
        left_panel
		.append("text")
		.attr("id", "side-panel-country")
		.attr("fill", "black")
		.attr("transform","translate(20,30)")
		.text(function(d) {
			if (country_in_focus_1 == "WORLD") {
				return "The World";
			} else {
				return  country_name_1;
			}
        })

		right_panel
		.append("text")
		.attr("fill", "black")
		.attr("id", "side-panel-country")
		.attr("transform","translate(20,30)")
		.text(function(d) {
			if (country_in_focus_2 == "WORLD") {
				return "The World";
			} else {
				return country_name_2;
			}
		})
    }

    function updatePanelTime(){

        d3.selectAll("#side-panel-time")
		  .remove()

        left_panel
		.append("text")
		.attr("id", "side-panel-time")
		.attr("fill", "black")
		.attr("transform","translate(20,50)")
		.text(function(d) {
			a = current_date.split("_")
            return "Trend in " + a[0] + " Q" + a[1]
        })

		right_panel
		.append("text")
		.attr("fill", "black")
		.attr("id", "side-panel-time")
		.attr("transform","translate(20,50)")
		.text(function(d) {
			a = current_date.split("_")
            return "Trend in "+ a[0] + " Q" + a[1]
        })
        
        var a_start
        var a_end

        left_panel
		.append("text")
		.attr("id", "side-panel-time")
		.attr("fill", "black")
		.attr("transform","translate(20," + (focusStremTartgetBottom-8) + ")")
		.text(function(d) {
            var start_index = Math.max(current_date_ind - rectWidthLeftSteps, 0)
            var end_index = Math.min(current_date_ind + rectWidthRightSteps, validTimeSteps.length)
            var start_date = validTimeSteps[start_index]
            var end_date = validTimeSteps[end_index]
            a_start = start_date.split("_")
            a_end = end_date.split("_")
            return "Trend between " + a_start[0] + " Q" + a_start[1] + " - " + a_end[0] + " Q" + a_end[1] 
        })

		right_panel
		.append("text")
		.attr("fill", "black")
		.attr("id", "side-panel-time")
		.attr("transform","translate(20," + (focusStremTartgetBottom-8) + ")")
		.text(function(d) {
			return "Trend between " + a_start[0] + " Q" + a_start[1] + " - " + a_end[0] + " Q" + a_end[1] 
		})
    }

            /// adding variables and rect for the focused stream graph

    var focusMargin = 20
    var focusStremTartgetBottom = height_main*0.4
    var focusStremTartgetLeft = focusMargin
    var focusStremTartgetRight = width_side_panel - focusMargin
    var focusStremTartgetTop =  height_main *0.6
    
    d3.select("#streamContainer")
        .append("g")
        .attr('id', "g-focus")
        .attr("transform",
            "translate(" + 38 + "," + 0 + ")");

    var svg_focused_stream = d3.selectAll("#g-focus")
    
    left_panel
            .append("rect")
            .attr('id', "rect-focus-left")
            .style("fill", "black")
            .attr("fill-opacity","0.1")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "gray")
            .attr("width", focusStremTartgetRight - focusStremTartgetLeft)
            .attr("height", focusStremTartgetTop - focusStremTartgetBottom)
            .attr("x", focusStremTartgetLeft)
            .attr("y", focusStremTartgetBottom);
		
    right_panel
            .append("rect")
            .attr('id', "rect-focus-right")
            .style("fill", "black")
            .attr("fill-opacity","0.1")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "gray")
            .attr("width", focusStremTartgetRight - focusStremTartgetLeft)
            .attr("height", focusStremTartgetTop - focusStremTartgetBottom)
            .attr("x", focusMargin)
            .attr("y", focusStremTartgetBottom);
       
	var close_button_offset_left = width_side_panel - 20
	var close_button_offset_top = 10
	var close_text_padding = 7.5
	
    left_panel
            .append("g")
            .attr('id', "rect-close-left")
            .attr("width", 10)
            .attr("height", 10)
			.attr("transform",
				"translate(" + close_button_offset_left + "," + close_button_offset_top + ")")
	
	var close_button_left = d3.select("#rect-close-left")
	close_button_left
			.append("rect")
	        .style("fill", "gray")
            .attr("width", 10)
            .attr("height", 10)
            .on("click", function(){resetSideBar("left")})
	
    close_button_left
			.append("text").text( "X")
			.attr("x", close_text_padding)
			.attr("y", close_text_padding)
			.attr("id", "close_text")
            .on("click", function(){resetSideBar("left")})
		
    right_panel
            .append("g")
			.attr('id', "rect-close-right")
            .attr("width", 10)
            .attr("height", 10)
			.attr("transform",
				"translate(" + close_button_offset_left + "," + close_button_offset_top + ")")
	
	var close_button_right = d3.select("#rect-close-right")
	
	close_button_right
			.append("rect")
            .style("fill", "gray")
            .attr("width", 10)
            .attr("height", 10)
            .on("click", function(){resetSideBar("right")})
	
	close_button_right
			.append("text").text( "X")
			.attr("x", close_text_padding)
			.attr("y", close_text_padding)
			.attr("id", "close_text")
            .on("click", function(){resetSideBar("right")})

		
	
    
    var left_focus_g = d3.select("#left_panel")
        .append("g")
        .attr('id', "g-focus-left")
        .attr("transform",
            "translate(" + 40+ "," + focusStremTartgetBottom + ")")
	
	left_focus_g
		.append("text")
		.attr("class", "graph_title_panel")
		.attr("x", -20)             
        .attr("y", -25)
        .attr("text-anchor", "left")    
        .text("Most popular tags")

    var right_focus_g = d3.select("#right_panel")
        .append("g")
        .attr('id', "g-focus-right")
        .attr("transform",
            "translate(" + 40+ "," + focusStremTartgetBottom + ")")
			
	right_focus_g
		.append("text")
		.attr("class", "graph_title_panel")
		.attr("x", -20)             
        .attr("y", -25)
        .attr("text-anchor", "left")    
        .text("Most popular tags");

    var svg_focused_stream = left_focus_g
    var prev_svg_focused_stream = right_focus_g
    var margin_focused = {top: 0, right: 0, bottom: 0, left: 0},
        width_stream_focused = focusStremTartgetRight 
        height_stream_focused = focusStremTartgetTop - focusStremTartgetBottom +5



    var x_main_stream = getX(validTimeSteps, width_stream)


    var rectAdd = 7
    var rectWidthRightSteps = 2
    var rectWidthLeftSteps = 2
    var rectWidthRight =(width_stream / validTimeSteps.length) * rectWidthRightSteps
    var rectWidthLeft = (width_stream / validTimeSteps.length) * rectWidthLeftSteps
    var rectHeight = height_stream - 2/rectAdd


    let drag = d3.drag()
        .on('drag', dragged)
    let dragLeft = d3.drag()
        .on('drag', draggedLeft) 
    let dragRight = d3.drag()
        .on('drag', draggedRight)


    drawStreamGraph(country_in_focus_1, current_selection_svg, validTimeSteps, width_stream, height_stream, "category", ticksEnabled = current_selection_ticks_enabled)
    drawStreamGraph(country_in_focus_1, svg_stream_2, validTimeSteps, width_stream, height_stream, "category")

    drawStreamGraph(country_in_focus_1, left_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
    drawStreamGraph(country_in_focus_1, right_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")

    updateStreamSlider()
    updatePanelCountry()
    updatedMultiDonut("WORLD",getFocusedValidSteps());
    updatedMultiDonutRight("WORLD", getFocusedValidSteps());


    //Donut chart 1 ...

function convertToDonut1(datum) {
 var fdata = {};
 var categories = [];
 var data = [];
 var device_data = datum.properties.device_data;
 for (var key in device_data) {
 	categories.push(key);
 }
 var colors = Highcharts.getOptions().colors;

  var typeData = [];
  var deviceData = [];
  var i;
  var j;
  var dataLen = categories.length;
  var drillDataLen;
  var brightness;
 for (i = 0; i < dataLen; i += 1) {

    // add type data
    typeData.push({
        name: categories[i],
        y: device_data[categories[i]].total,  //data[i].y,
        color: colors[i] //data[i].color
    });

    // add device data 
    drillDataLen = device_data[categories[i]].length - 1 //data[i].drilldown.data.length;
    if (categories[i] == "others") {
    	drillDataLen += 1;
    }
    for (var keys2 in device_data[categories[i]]) {
    	if (keys2 != 'total' || categories[i] == "others"){
      	        brightness = 0.2 - (j / drillDataLen) / 5;
        deviceData.push({
            name: keys2, //device_data[categories[i]][j],
            y: device_data[categories[i]][keys2], //data[i].drilldown.data[j],
            color: Highcharts.color(colors[i]).brighten(brightness).get()
        });
      }
    }
}
var retData = {};
retData.typeData = typeData;
retData.deviceData = deviceData;
return retData;
}



// function refreshDonutDiv(dat){

// var donut1data = convertToDonut1(dat);


// // Create the chart
// Highcharts.chart('donut', {
// chart: {
//     type: 'pie'
// },
// title: {
//     text: 'Device usage trend'
// },
// subtitle: {
//     text: 'Source: Flickr dataset'
// },
// credits: {
//     enabled: false
// },
// plotOptions: {
//     pie: {
//         shadow: false,
//         center: ['50%', '50%']
//     }
// },
// tooltip: {
//     valueSuffix: '%'
// },
// series: [{
//     name: 'Device',
//     data: donut1data.typeData,
//     size: '60%',
//     dataLabels: {
//         formatter: function () {
//             return this.y > 5 ? this.point.name : null;
//         },
//         color: '#ffffff',
//         distance: -30
//     }
// }, {
//     name: 'Models',
//     data: donut1data.deviceData,
//     size: '80%',
//     innerSize: '60%',
//     dataLabels: {
//         formatter: function () {
//             // display only if larger than 1
//             return this.y > 1 ? '<b>' + this.point.name + ':</b> ' +
//                 this.y + '' : null;
//         }
//     },
//     id: 'versions'
// }],
// responsive: {
//     rules: [{
//         condition: {
//             maxWidth: 400
//         },
//         chartOptions: {
//             series: [{
//             }, {
//                 id: 'versions',
//                 dataLabels: {
//                     enabled: false
//                 }
//             }]
//         }
//     }]
// }
// });


// }

function refreshSidePanelPie1(dat, streamUpdate = false) {
    //var dat = [];//[{"name":"animal","y":1},{"name":"citylife","y":9},{"name":"nature","y":13},{"name":"other","y":12},{"name":"people","y":28},{"name":"sports","y":0}];
    var newDat = [];
    var colors = [];
   if (dat != "WORLD" && !streamUpdate) {
        var chkData = dat.properties.most_popular_5;
for (var key in chkData) {
	var obj = {};
  obj.name = key;
  obj.y = chkData[key];
  newDat.push(obj);
  colors.push(myColor(key));
}
    // document.getElementById("popcat1").innerText = dat.properties.most_popular_tag;
    // document.getElementById("imageno1").innerText = dat.properties.user_freq;
    } else {
        // WORLD data..
        var countrydata = countries_mock_data.timesteps[current_date].country_data.buckets;
        
        for (var idx = 0; idx < countrydata.length; ++idx) {
            if (countrydata[idx].key.toUpperCase() === dat.toUpperCase()) {
                // document.getElementById("popcat1").innerText = countrydata[idx].most_popular_category;
                // document.getElementById("imageno1").innerText = countrydata[idx].user_freq;
                var worldCatData = countrydata[idx].categories_sum;
                for (var categories in worldCatData) {
                    var obj = {};
                    obj.name = categories;
                    obj.y = worldCatData[categories];
                    newDat.push(JSON.parse(JSON.stringify(obj)));
                    colors.push(myColor(categories));
                }
                break;
            }
        }
    }


    console.log("pie")


    Highcharts.chart('1tipDiv', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie',
        width: 185,
        backgroundColor: 'transparent'
    },
    title: {
		text: 'Distribution of categories',
        style: {
            fontSize: 14
        }
    },
    credits: {
        enabled: false
    },
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },	
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: true,
                distance: -25,
                format: '{point.y}'
            },
            showInLegend: false,
            animation: true
        }
    },
    series: [{
        name: 'Flickr Tags',
        colorByPoint: true,
        colors: colors,
        data: newDat
    }],
    exporting: {
        enabled: false
    }
});   
}

function refreshSidePanelPie2(dat, streamUpdate = false) {
    //var dat = [];//[{"name":"animal","y":1},{"name":"citylife","y":9},{"name":"nature","y":13},{"name":"other","y":12},{"name":"people","y":28},{"name":"sports","y":0}];
    var newDat = [];
    var colors = [];
    if (dat != "WORLD" && !streamUpdate) {
        var chkData = dat.properties.most_popular_5;
for (var key in chkData) {
	var obj = {};
  obj.name = key;
  obj.y = chkData[key];
  newDat.push(obj);
  colors.push(myColor(key));
}
// document.getElementById("popcat2").innerText = dat.properties.most_popular_tag;
//     document.getElementById("imageno2").innerText = dat.properties.user_freq;
    }  else {
        // WORLD data..
        var countrydata = countries_mock_data.timesteps[current_date].country_data.buckets;
        
        for (var idx = 0; idx < countrydata.length; ++idx) {
            if (countrydata[idx].key.toUpperCase() === dat.toUpperCase()) {
                // document.getElementById("popcat2").innerText = countrydata[idx].most_popular_category;
                // document.getElementById("imageno2").innerText = countrydata[idx].user_freq;
                var worldCatData = countrydata[idx].categories_sum;
                for (var categories in worldCatData) {
                    var obj = {};
                    obj.name = categories;
                    obj.y = worldCatData[categories];
                    newDat.push(JSON.parse(JSON.stringify(obj)));
                    colors.push(myColor(categories));
                }
                break;
            }
        }
    }

    Highcharts.chart('2tipDiv', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie',
        width: 150,
        backgroundColor: 'transparent'
    },
    title: {
		text: 'Distribution of categories',
        style: {
            color: '#2e2e2e',
            fontSize: 12
        }
    },
    credits: {
        enabled: false
    },
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },	
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: true,
                distance: -25,
                format: '{point.y}'
            },
            showInLegend: false,
            animation: true
        }
    },
    series: [{
        name: 'Flickr Tags',
        colorByPoint: true,
        colors: colors,
        data: newDat
    }],
    exporting: {
        enabled: false
    }
});   
}

//Add world data..
refreshSidePanelPie1("WORLD");
refreshSidePanelPie2("WORLD");

function refreshPie1(dat) {
    var newDat = [];
    var colors = [];
var chkData = dat.properties.most_popular_5;
for (var key in chkData) {
	var obj = {};
  obj.name = key;
  obj.y = chkData[key];
  newDat.push(obj);
  colors.push(myColor(key));
}


Highcharts.chart('tipDiv', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie',
		height: 220
    },
    title: {
		text: 'Distribution of categories',
        style: {
            color: '#2e2e2e',
            fontSize: 12
        }
    },
    credits: {
        enabled: false
    },
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },	
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: true,
                distance: -25,
                format: '{point.y}'
            },
            showInLegend: false,
            animation: false
        }
    },
    series: [{
        name: 'Flickr Tags',
        colorByPoint: true,
        colors: colors,
        data: newDat
    }],
    exporting: {
        enabled: false
    }
});
}

// function refreshPieDiv(dat) {
//     var newDat = [];
//     var colors = [];
// var chkData = dat.properties.most_popular_5;
// for (var key in chkData) {
// 	var obj = {};
//   obj.name = key;
//   obj.y = chkData[key];
//   newDat.push(obj);
//   colors.push(myColor(key));
// }

// Highcharts.chart('pie', {
//     chart: {
//         plotBackgroundColor: null,
//         plotBorderWidth: null,
//         plotShadow: false,
//         type: 'pie'
//     },
//     title: {
//         text: 'Top 5 category trends'
//     },
//     credits: {
//         enabled: false
//     },
//     tooltip: {
//         pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
//     },
//     accessibility: {
//         point: {
//             valueSuffix: '%'
//         }
//     },
//     plotOptions: {
//         pie: {
//             allowPointSelect: true,
//             cursor: 'pointer',
//             dataLabels: {
//                 enabled: true,
//                 format: '<b>{point.name}</b>: {point.percentage:.1f} %'
//             },
//             showInLegend: true
//         }
//     },
//     series: [{
//         name: 'Flickr Tags',
//         colorByPoint: true,
//         colors: colors,
//         data: newDat
//     }]
// });
// }


// function getTagPerCategories(dat) {

//     catArray = [];
//     var tempData = dat.properties.most_popular_5;
//     var map = [];
//     var i=0;
//     for (var key in tempData) {
//         if (key != 'unknown' && tempData[key] != 0) {
//             catArray.push(key);
//             map[key] = i++;
//         }
//     }
//     var seriesData = [];
//     var categoryData = dat.properties.category_trend;
//     var tagMap = [];
//     for (var cat in catArray) {
//         var catTags = categoryData[catArray[cat]].top_5;
//         for (var tags in catTags) {
//             if (tagMap[tags] == null) {
//                 //First Time..
//                 tagMap[tags] = Array(catArray.length).fill(0);
//                 tagMap[tags][map[catArray[cat]]] = catTags[tags];
//             } 
//             else {
//                 tagMap[tags][map[catArray[cat]]] = catTags[tags];
//             }
//         }
//     }



//     for (var key in tagMap){
//         var obj = {};
//         obj.name = key;
//         obj.data = tagMap[key];
//         seriesData.push(obj);
//     }


/*series: [{
      data: [],
      name: ,
      color
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }, {
      data: []
    }]*/

    function refreshSidePanelTopTags1(dat, streamUpdate = false) {
        // select the svg area
        d3.selectAll("#svgPie1").selectAll(".dot1").remove();
var Svg = d3.select("#svgPie1")

//var tpKeys = ["2004", "geotagged", "johnkerry", "politicalevent", "politicalevents"];
var topValues = [];
var legData = [];
if (dat != "WORLD" && !streamUpdate) {
    var catTagData = dat.properties.category_trend;
    for (var category in catTagData) {
        var top5 = catTagData[category].top_5;
        for (var tagName in top5) {
            var obj = {};
            obj.data = top5[tagName];
            obj.name = tagName;
            obj.color = myColor(category);
            legData.push(JSON.parse(JSON.stringify(obj)));
        }
    }

} else {
    var bucketData = countries_mock_data.timesteps[current_date].country_data.buckets;
    for (var idx=0; idx<bucketData.length; ++idx) {
        if (bucketData[idx].key.toUpperCase() === dat.toUpperCase()) {
            
            var countData = bucketData[idx].categories;
            for (var category2 in countData) {
                var top5 = countData[category2].top_5;
                for (var tagName2 in top5) {
                    var obj2 = {};
                    obj2.data = top5[tagName2];
                    obj2.name = tagName2;
                    obj2.color = myColor(category2);
                    legData.push(JSON.parse(JSON.stringify(obj2)));
                }
            }
            break;
        }
    }
}

topValues = legData.sort(function(a, b) {
        return b.data - a.data;
    }).slice(0,5);

    var tpKeys = [];
for (var idx = 0; idx < topValues.length; ++idx) {
    tpKeys.push(topValues[idx].name);
}


// Add one dot in the legend for each name.
Svg.selectAll("mydots")
  .data(tpKeys)
  .enter()
  .append("circle")
    .attr("cx", 14)
    .attr("cy", function(d,i){ return (i+1)*20})
    .attr("r", 7)
    .attr("class","dot1")
    .style("fill", function(d){ return myColor(reverseTagCatIndex[d])})

// Add one dot in the legend for each name.
Svg.selectAll("mylabels")
  .data(tpKeys)
  .enter()
  .append("text")
    .attr("x", 28)
    .attr("y", function(d,i){ return (i+1)*20}) // 100 is where the first dot appears. 25 is the distance between dots
    .style("fill", function(d){ return "#000"})
    .text(function(d){ return d})
    .attr("text-anchor", "left")
    .attr("class", "dot1")
    .style("alignment-baseline", "middle")





    }


    function refreshSidePanelTopTags2(dat, streamUpdate = false) {
        // select the svg area
        d3.selectAll("#svgPie2").selectAll(".dot2").remove();
var Svg = d3.select("#svgPie2")

//var tpKeys = ["2004", "geotagged", "johnkerry", "politicalevent", "politicalevents"];
var topValues = [];
var legData = [];
if (dat != "WORLD" && !streamUpdate) {
    var catTagData = dat.properties.category_trend;
    for (var category in catTagData) {
        var top5 = catTagData[category].top_5;
        for (var tagName in top5) {
            var obj = {};
            obj.data = top5[tagName];
            obj.name = tagName;
            obj.color = myColor(category);
            legData.push(JSON.parse(JSON.stringify(obj)));
        }
    }

} else {
    var bucketData = countries_mock_data.timesteps[current_date].country_data.buckets;
    for (var idx=0; idx<bucketData.length; ++idx) {
        if (bucketData[idx].key.toUpperCase() === dat.toUpperCase()) {
            
            var countData = bucketData[idx].categories;
            for (var category2 in countData) {
                var top5 = countData[category2].top_5;
                for (var tagName2 in top5) {
                    var obj2 = {};
                    obj2.data = top5[tagName2];
                    obj2.name = tagName2;
                    obj2.color = myColor(category2);
                    legData.push(JSON.parse(JSON.stringify(obj2)));
                }
            }
            break;
        }
    }
}

topValues = legData.sort(function(a, b) {
        return b.data - a.data;
    }).slice(0,5);

    var tpKeys = [];
for (var idx = 0; idx < topValues.length; ++idx) {
    tpKeys.push(topValues[idx].name);
}

// Add one dot in the legend for each name.
Svg.selectAll("mydots")
  .data(tpKeys)
  .enter()
  .append("circle")
    .attr("cx", 14)
    .attr("cy", function(d,i){ return (i+1)*20})
    .attr("r", 7)
    .attr("class","dot2")
    .style("fill", function(d){ return myColor(reverseTagCatIndex[d])})

// Add one dot in the legend for each name.
Svg.selectAll("mylabels")
  .data(tpKeys)
  .enter()
  .append("text")
    .attr("x", 28)
    .attr("y", function(d,i){ return (i+1)*20}) // 100 is where the first dot appears. 25 is the distance between dots
    .style("fill", function(d){ return "#000"})
    .text(function(d){ return d})
    .attr("text-anchor", "left")
    .attr("class", "dot2")
    .style("alignment-baseline", "middle")





    }

    refreshSidePanelTopTags1("WORLD");
    refreshSidePanelTopTags2("WORLD");


    function refreshTopTags(dat) {
        //var catTagData = countries_mock_data.timesteps[ts].country_data.buckets[0].categories;
        var catTagData = dat.properties.category_trend;
        var legData = [];
            for (var category in catTagData) {
                var top5 = catTagData[category].top_5;
                for (var tagName in top5) {
                    //legData[tagName] = top5[tagName];
                    var obj = {}; 
                    obj.data = top5[tagName];
                    obj.name = tagName;
                    obj.color = myColor(category);
                    legData.push(JSON.parse(JSON.stringify(obj)));
                }
            }


//         x.sort(function(a, b) {
// return b.score - a.score;
// });
        var topValues = legData.sort(function(a, b) {
                return b.data - a.data;
        }).slice(0,5);


        // select the svg area
var Svg = d3.select("#my_dataviz2")

// var tpKeys = [];
// for (var idx = 0; idx < topValues.length; ++idx) {
//     tpKeys.push(topValues[idx].name);
// }


// Usually you have a color scale in your chart already
// var color = d3.scaleOrdinal()
//   .domain(tpKeys)
//   .range(d3.schemeSet2);

// Add one dot in the legend for each name.
Svg.selectAll("mydots")
  .data(topValues)
  .enter()
  .append("circle")
    .attr("cx", 14)
    .attr("cy", function(d,i){ return (i+1)*20})
    .attr("r", 7)
    .style("fill", function(d){ return d.color})

// Add one dot in the legend for each name.
Svg.selectAll("mylabels")
  .data(topValues)
  .enter()
  .append("text")
    .attr("x", 28)
    .attr("y", function(d,i){ return (i+1)*20}) // 100 is where the first dot appears. 25 is the distance between dots
    .style("fill", function(d){ return "#000"})
    .text(function(d){ return d.name})
    .attr("text-anchor", "left")
    .style("alignment-baseline", "middle")





    }

    
// }


var randomColor = (function(){
  var golden_ratio_conjugate = 0.618033988749895;
  var h = Math.random();

  var hslToRgb = function (h, s, l){
      var r, g, b;

      if(s == 0){
          r = g = b = l; // achromatic
      }else{
          function hue2rgb(p, q, t){
              if(t < 0) t += 1;
              if(t > 1) t -= 1;
              if(t < 1/6) return p + (q - p) * 6 * t;
              if(t < 1/2) return q;
              if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
              return p;
          }

          var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          var p = 2 * l - q;
          r = hue2rgb(p, q, h + 1/3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1/3);
      }

      return '#'+Math.round(r * 255).toString(16)+Math.round(g * 255).toString(16)+Math.round(b * 255).toString(16);
  };
  
  return function(){
    h += golden_ratio_conjugate;
    h %= 1;
    return hslToRgb(h, 0.5, 0.60);
  };
})();

function isEmpty(obj) {
  for(var prop in obj) {
    if(obj.hasOwnProperty(prop)) {
      return false;
    }
  }

  return JSON.stringify(obj) === JSON.stringify({});
}



function reDrawMultiDonut(newData) {

    //console.log(JSON.stringify(newData));
    d3.selectAll("#left_panel").selectAll("#donut-class").remove();
    // d3.selectAll('#chart-parent')
    //     .append("div")
    //     .attr("class", "chart");
    // for (var i=0; i<k; ++i) {
    //     svg2[i].exit().remove();
    // }


        var width2 = width_side_panel; //width_main;
        var height2 = 280; //height_main;
        var donutWidth = 15;
        var idx=0;
        if (Object.keys(newData).length > 5) {
            idx = Object.keys(newData).length - 5;   

        }
    var svgDonut = d3.select('#left_panel')
          .append('svg')
          .attr("id","donut-class")
          .attr('width', width2)
          .attr('height', height2)
          .attr("x", width_side_panel*0.01)
          .attr("y", (height_main *0.63))
		  
	svgDonut
		.append("text")
		.attr("class", "graph_title_panel")
		.attr("x", 20)             
        .attr("y", 10)
        .attr("text-anchor", "left")    
        .text("Device category and brand")
		
    var pie = d3.pie()
          .value(function(d) { return d.count; })
          .sort(null)
	      .startAngle(1.1*Math.PI)
          .endAngle(3.1*Math.PI);

    //Removing all path donut elements..
    //d3.select(".donut-path").selectAll("*").remove();
    var svg2 = [];
    var k=0;
    var radius1 = Math.min(width2, height2) / 8;
    var radius2 = radius1 + donutWidth + 5;
    var arc_bound = 5;
            //Draw for the first time..
            var iloop = 0;
            for (var timestepKey in newData) {
                if (iloop < idx) {
                    iloop++;
                    continue;
                }
            svg2[k] = svgDonut.append('g')
            .attr('transform', 'translate(' + (width2 / 2) + 
            ',' + (height2 /2 ) + ')');

            var arc2 = d3.arc()
                .innerRadius(radius1 - donutWidth)  
                .outerRadius(radius1);

            

            

          var path2 = svg2[k].selectAll('path')
          .data(pie(newData[timestepKey]))
          .enter()
          .append('path')
          .attr('d', arc2)
          .attr("class", "donut-path")
          .style("stroke", "#eee")
          .style("stroke-width", 3)
          .attr('fill', function(d, i) { 
            return catColor[d.data.category];
          });
        //   .transition().delay(function(d,i) {
        //       return i*500;
        //   })
        //   .duration(500)
        //   .attrTween('d', function(d) {
        //     var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
        //     return function(t) {
        //         d.endAngle = i(t);
        //         return arc2(d)
        //     }
        //   });

          radius1 = radius1 + donutWidth + arc_bound;

          k++;

        }

        d3.selectAll(".donut-path").on("mousemove", function(d) {
	    div.style("left", d3.event.pageX+10+"px");
		  div.style("top", d3.event.pageY-25+"px");
		  div.style("display", "inline-block");
    div.html("Timestep: "+(d.data.timestep)+"<br>"+(d.data.device)+"<br>"+(d.data.count) + "<br>Category: "+(d.data.category));
});

    d3.selectAll(".donut-path").on("mouseout", function(d){
    div.style("display", "none");
});

}

function updatedMultiDonut(country_code, timeSteps) {
    var newData = {};
        for(var key_st in countries_mock_data.timesteps) {
            if (timeSteps.includes(key_st)) {
                if (key_st != null && key_st != undefined) {
            var timeArray = [];
            var tp = countries_mock_data.timesteps[key_st].country_data.buckets;
        //Select the country..
        // for( var idx=0; idx<=countries_mock_data.timesteps[key_st].country_data.buckets.length; ++idx) {
            var country_bucket = tp.find( function (e){
                            return e.key.toUpperCase() == country_code.toUpperCase()
                        })
            if (country_bucket) {
                var deviceData = country_bucket.device_data;

                for (var deviceCategory in deviceData) {
                    if(!isEmpty(deviceData[deviceCategory])) {
                        for (var devices in deviceData[deviceCategory]) {
                            var obj2 = {};
                            obj2.count = deviceData[deviceCategory][devices];
                            obj2.category = deviceCategory;
                            obj2.device = devices;
                            obj2.timestep = key_st;
                            timeArray.push(JSON.parse(JSON.stringify(obj2)));
                        }
                        
                    }
                }
                newData[key_st] = JSON.parse(JSON.stringify(timeArray));
            }
                
        //}
        }
            }
        
        
    }

    //newData = {};
    reDrawMultiDonut(newData);
}

function reDrawMultiDonutRight(newData) {

//console.log(JSON.stringify(newData));
d3.selectAll("#right_panel").selectAll("#donut-class").remove();
// d3.selectAll('#chart-parent')
//     .append("div")
//     .attr("class", "chart");
// for (var i=0; i<k; ++i) {
//     svg2[i].exit().remove();
// }


    var width2 = width_side_panel; //width_main;
    var height2 = 280; //height_main;
    var donutWidth = 15;
    var idx=0;
        if (Object.keys(newData).length > 5) {
            idx = Object.keys(newData).length - 5;   

        }
    
var svgDonut = d3.select('#right_panel')
      .append('svg')
      .attr("id","donut-class")
      .attr('width', width2)
      .attr('height', height2)
      .attr("x", width_side_panel*0.01)
      .attr("y", (height_main *0.63));

	svgDonut
		.append("text")
		.attr("class", "graph_title_panel")
		.attr("x", 20)             
        .attr("y", 10)
        .attr("text-anchor", "left")    
        .text("Device category and brand")
	  
      var pie = d3.pie()
      .value(function(d) { return d.count; })
      .sort(null)
      .startAngle(1.1*Math.PI)
      .endAngle(3.1*Math.PI);

//Removing all path donut elements..
//d3.select(".donut-path").selectAll("*").remove();
var svg2 = [];
var k=0;
var radius1 = Math.min(width2, height2) / 8;
var radius2 = radius1 + donutWidth + 5;
var arc_bound = 5;
            //Draw for the first time..
            var iloop = 0;
            
        //Draw for the first time..
        for (var timestepKey in newData) {
            if (iloop < idx) {
                    iloop++;
                    continue;
                }
        svg2[k] = svgDonut.append('g')
        .attr('transform', 'translate(' + (width2 / 2) + 
        ',' + (height2 / 2) + ')');

        var arc2 = d3.arc()
            .innerRadius(radius1 - donutWidth)  
            .outerRadius(radius1);

        

        

      var path2 = svg2[k].selectAll('path')
      .data(pie(newData[timestepKey]))
      .enter()
      .append('path')
      .attr('d', arc2)
      .attr("class", "donut-path")
      .style("stroke", "#eee")
      .style("stroke-width", 3)
      .attr('fill', function(d, i) { 
        return catColor[d.data.category];
      });
    //   .transition().delay(function(d,i) {
    //       return i*500;
    //   })
    //   .duration(500)
    //   .attrTween('d', function(d) {
    //     var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
    //     return function(t) {
    //         d.endAngle = i(t);
    //         return arc2(d)
    //     }
    //   });

      radius1 = radius1 + donutWidth + arc_bound;

      k++;

    }

    d3.selectAll(".donut-path").on("mousemove", function(d) {
    div.style("left", d3.event.pageX+10+"px");
      div.style("top", d3.event.pageY-25+"px");
      div.style("display", "inline-block");
div.html("Timestep: "+(d.data.timestep)+"<br>"+(d.data.device)+"<br>"+(d.data.count) + "<br>Category: "+(d.data.category));
});

d3.selectAll(".donut-path").on("mouseout", function(d){
div.style("display", "none");
});

}


function updatedMultiDonutRight(country_code, timeSteps) {
    var newData = {};
        for(var key_st in countries_mock_data.timesteps) {
            if (timeSteps.includes(key_st)) {
                if (key_st != null && key_st != undefined) {
            var timeArray = [];
            var tp = countries_mock_data.timesteps[key_st].country_data.buckets;
        //Select the country..
        // for( var idx=0; idx<=countries_mock_data.timesteps[key_st].country_data.buckets.length; ++idx) {
            var country_bucket = tp.find( function (e){
                            return e.key.toUpperCase() == country_code.toUpperCase()
                        })
            if (country_bucket) {
                var deviceData = country_bucket.device_data;

                for (var deviceCategory in deviceData) {
                    if(!isEmpty(deviceData[deviceCategory])) {
                        for (var devices in deviceData[deviceCategory]) {
                            var obj2 = {};
                            obj2.count = deviceData[deviceCategory][devices];
                            obj2.category = deviceCategory;
                            obj2.device = devices;
                            obj2.timestep = key_st;
                            timeArray.push(JSON.parse(JSON.stringify(obj2)));
                        }
                        
                    }
                }
                newData[key_st] = JSON.parse(JSON.stringify(timeArray));
            }
                
        //}
        }
            }
        
        
    }

    //newData = {};
    reDrawMultiDonutRight(newData);
}







// var donutData = [];
// //Taking USA for now..


// //Year_month parsing..(each one layer on top..)
// for(var year_month in countries_mock_data.timesteps) {

// }



// var sampleData = [{
//             noOfDevices: 25,
//             name: "Canon",
//             type: "Camera",
//             timestep: "2001_01",
//             drilldown: [{
//                 noOfDevices: 20,
//                 name: "",
//                 drilldown: [{
//                     noOfDevices: 10,
//                     name: "camera",
//                     drilldown: [{
//                         noOfDevices: 5,
//                         name: "Canon",
//                         drilldown: []
//                     }, {
//                         noOfDevices: 5,
//                         name: "Nikon",
//                         drilldown: []
//                     }]
//                 }, {
//                     noOfDevices: 5,
//                     name: "phone",
//                     drilldown: [{
//                         noOfDevices: 5,
//                         name: "FujiFilm",
//                         drilldown: []
//                     }]
//                 }]
//             }, {
//                 noOfDevices: 10,
//                 name: "2001_02",
//                 drilldown: [{
//                     noOfDevices: 8,
//                     name: "camera",
//                     drilldown: [{
//                         noOfDevices: 8,
//                         name: "Nikon",
//                         drilldown: []
//                     }]
//                 }, {
//                     noOfDevices: 2,
//                     name: "others",
//                     drilldown: [{
//                         noOfDevices: 2,
//                         name: "others",
//                         drilldown: []
//                     }]
//                 }]
//             }]
//         }];

//         var config = {
//             containerId: "chartContainer",
//             width: 500,
//             height: 500,
//             data: sampleData,
//             heading: {
//                 text: "Device trends",
//                 pos: "top"
//             },
//             label: function(d) {
//                 return d.data.name + ":" + d.data.noOfDevices;
//             },
//             value: "noOfDevices",
//             inner: "drilldown",
//             tooltip: function(d) {
//                 return "<div style='background-color: #4a4; color: white; padding: 15px; text-align: middle; border: dotted 1px black;'><strong>" + d.name + "</strong> has " + d.noOfDevices + " Devices used.</div>";
//             },
//             transition: "linear",
//             transitionDuration: 100,
//             donutRadius: 50,
//             gradient: true,
//             colors: randomColor,
//             labelColor: "white",
//             stroke: "#eee",
//             strokeWidth: 3,
//             drilldownTransition: "linear",
//             drilldownTransitionDuration: 0,
//             highlightColor: "#c00"
//         };

//         var samplePie = new multidonut.Pie(config);


var svgLegend = d3.select("#legend");

	d3.select("#legend")
		.style("bottom", 20 +"px")
		.style("left", width_main*0.5 + "px")
	
// Add one dot in the legend for each name.
svgLegend.selectAll("mydots")
  .data(countries_mock_data.allCategories)
  .enter()
  .append("circle")
    .attr("cy", 8)
    .attr("cx", function(d,i){ return 20 + i*50}) // 100 is where the first dot appears. 25 is the distance between dots
    .attr("r", 7)
    .style("fill", function(d){ return myColor(d)})

// Add one dot in the legend for each name.
svgLegend.selectAll("mylabels")
  .data(countries_mock_data.allCategories)
  .enter()
  .append("text")
    .attr("y", 26)
    .attr("x", function(d,i){ return 15+ i*50-10}) // 100 is where the first dot appears. 25 is the distance between dots
    //.style("fill", function(d){ return color(d)})
    .text(function(d){ return d})
    .attr("text-anchor", "left")
    .style("alignment-baseline", "middle")



var svgDonutLegend = d3.select("#donutLegend");

// Add one dot in the legend for each name.
svgDonutLegend.selectAll("mydots")
  .data(Object.keys(catColor))
  .enter()
  .append("circle")
    .attr("cy", 10)
    .attr("cx", function(d,i){ return 135 + i*50}) // 100 is where the first dot appears. 25 is the distance between dots
    .attr("r", 7)
    .style("fill", function(d){ return catColor[d]})

// Add one dot in the legend for each name.
svgDonutLegend.selectAll("mylabels")
  .data(Object.keys(catColor))
  .enter()
  .append("text")
    .attr("y", 30)
    .attr("x", function(d,i){ return 120+i*52-10}) // 100 is where the first dot appears. 25 is the distance between dots
    //.style("fill", function(d){ return color(d)})
    .text(function(d){ return d})
    .attr("text-anchor", "left")
    .style("alignment-baseline", "middle")
        
right_panel
	.append("g")
	.attr("id", "donutLegend2")
	.attr("width", 300)
	.attr("height", 50)

var svgDonutLegend2 = d3.selectAll("#donutLegend2");

// Add one dot in the legend for each name.
svgDonutLegend2.selectAll("mydots")
  .data(Object.keys(catColor))
  .enter()
  .append("circle")
    .attr("cy", height_main *0.95+10)
    .attr("cx", function(d,i){ return 145 + i*50}) // 100 is where the first dot appears. 25 is the distance between dots
    .attr("r", 7)
    .style("fill", function(d){ return catColor[d]})

// Add one dot in the legend for each name.
svgDonutLegend2.selectAll("mylabels")
  .data(Object.keys(catColor))
  .enter()
  .append("text")
    .attr("y", height_main *0.95 +30)
    .attr("x", function(d,i){ return 130+ i*52-10}) // 100 is where the first dot appears. 25 is the distance between dots
    //.style("fill", function(d){ return color(d)})
    .text(function(d){ return d})
    .attr("text-anchor", "left")
    .style("alignment-baseline", "middle")
	.style("fill", "black")
    </script>

        
    </body>
    {% endblock %}
