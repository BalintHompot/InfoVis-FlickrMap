{% extends "base.html" %}
{% block title %}Trend Analysis of Flickr Tags{% endblock %}
{% block body %}
    <head>
		
        <meta charset="utf-8">
 <!--       <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> -->
        <style>
        {% include 'multidonut.css' %}
        </style> 
		<script type="text/javascript">
			d3.selectAll(".nav-item").classed("active", false);
			d3.select("#nav-link-map").classed("active", true);
		</script>
        <script>
            {% include 'multidonut.js' %}
        </script>
        <!-- <script type="text/javascript" src="psd3.js"></script> -->
        <!-- <link rel="stylesheet" type="text/css" href="psd3.css" /> -->
        <style>
            /* CSS goes here. */
			
			text {
				font-family: -apple-system, BlinkMacSystemFontsystem-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; 
			}
			
			#main-content-container {
				margin: 0;
				padding: 0;
			}
			
            .subunit {	
                fill: none;
                stroke: #FFF;
                stroke-width: 1px;
            }
            text.subunit-label {
                font-family: font-family: -apple-system, BlinkMacSystemFontsystem-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; 
                font-size: 14px;
                font-weight: 300;
                text-anchor: middle;
                fill: #000;
            }
            .subunit-label {
                display: none;
            }
            .graticule {
                fill: none;
                stroke: #aaa;
                stroke-opacity: .5;
                stroke-width: .5px;
            }

            .background {
            fill: none;
            pointer-events: all; 
            }

            .feature {
            fill: #ccc;
            cursor: pointer;
            }

            .feature.active {
            fill: orange;
            }

            .mesh {
            fill: none;
            stroke: #fff;
            stroke-linecap: round;
            stroke-linejoin: round;
            }

            .rect {
                border-radius: 3px;
            }







            #container {
				height: 400px; 
			}

			.highcharts-figure, .highcharts-data-table table {
				min-width: 320px; 
				max-width: 800px;
				margin: 1em auto;
			}

			.highcharts-data-table table {
				font-family: Verdana, sans-serif;
				border-collapse: collapse;
				border: 1px solid #EBEBEB;
				margin: 10px auto;
				text-align: center;
				width: 100%;
				max-width: 500px;
			}
			.highcharts-data-table caption {
				padding: 1em 0;
				font-size: 1.2em;
				color: #555;
			}
			.highcharts-data-table th {
				font-weight: 600;
				padding: 0.5em;
			}
			.highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
				padding: 0.5em;
			}
			.highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
				background: #f8f8f8;
			}
			.highcharts-data-table tr:hover {
				background: #f1f7ff;
			}
			.slider{
				width: 800px;
			}



		/* CSS for tabs */


		#exTab1 .tab-content {
		  color : white;
		  background-color: #428bca;
		  padding : 5px 15px;
		}

		#exTab2 h3 {
		  background-color: white;
		  padding : 5px 15px;
		}

		/* remove border radius for the tab */

		#exTab1 .nav-pills > li > a {
		  border-radius: 0;
		}

		/* change border radius for the tab , apply corners on top*/

		#exTab3 .nav-pills > li > a {
		  border-radius: 4px 4px 0 0 ;
		}

		#exTab3 .tab-content {
		  color : white;
		  background-color: #428bca;
		  padding : 5px 15px;
		}

		path:hover
		{
			fill-opacity: .5;
		}
		  
		.axis path {
		  fill: none;
		}
		  
		.axis line {
		  fill: none;
		  stroke: rgba(0, 0, 0, 0.5);
		}
		  
		.background
		{
			fill: transparent;
			pointer-events: all;
		}

		.legend
		{
			position:absolute;
			left:20px;
			top:30px;
		}
		  
		.d3-tip
		{
			line-height: 1;
			width: 800px;
			height: fit-content;
			padding: 12px;
			/*background: rgba(204, 188, 188, 0.836)*/
			background-color: lavender;
			color: black;
			border-radius: 2px;
		}

		.d3-tip:after
		{
			box-sizing: border-box;
			width: 800px;
			height: fit-content;
			font-size: 5px;
			line-height: 1;
			/*color: rgba(204, 188, 188, 0.836);*/
			background-color: lavender;
			content: "\25BC";
			position: absolute;
			text-align: center;
		}

		.d3-tip.n:after
		{
			margin: -1px 0 0 0;
			width: 800px;
			height: fit-content;
			top: 100%;
			left: 0;
		}
		  
		#tipDiv
		{
			width: 400px;
		}

		#tipDiv2
		{
			width: 380px;
		}

		#button {
		  background: #ccc;
		  cursor: pointer;
		  border-top: solid 2px #eaeaea;
		  border-left: solid 2px #eaeaea;
		  border-bottom: solid 2px #777;
		  border-right: solid 2px #777;
		  padding: 5px 5px;
		}

		#button.down {
		  background: #bbb;
		  border-top: solid 2px #777;
		  border-left: solid 2px #777;
		  border-bottom: solid 2px #eaeaea;
		  border-right: solid 2px #eaeaea;
		}


		.arc text {
		  font: 10px sans-serif;
		  text-anchor: middle;
		}

		.arc path {
		  stroke: #fff;
		}

		.toolTip {
			position: absolute;
			display: none;
			width: auto;
			height: auto;
			background: none repeat scroll 0 0 white;
			border: 0 none;
			border-radius: 8px 8px 8px 8px;
			box-shadow: -3px 3px 15px #888888;
			color: black;
			font: 12px sans-serif;
			padding: 5px;
			text-align: center;
		}



        </style>
    </head>
    <body>


        <script src="//d3js.org/topojson.v1.min.js"></script>
        <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src=".https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://code.highcharts.com/highcharts.js"></script>   
        <script src="https://code.highcharts.com/highcharts-more.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>   
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
        <script src="https://code.highcharts.com/modules/accessibility.js"></script>
        <script src="https://code.highcharts.com/modules/no-data-to-display.js"></script>

        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>

        


        <div>
      
            <span>

                <div id="tooltip-holder"></div>
                <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

                <!-- Create a div where the graph will take place -->
     
                <div id="my_dataviz"></div>
              
        
            </span>

            <div id="chartContainer" class="well"></div>

            <hr></hr>
            <a id="button" title="button">Device Categories</a>
            <div class="container"><h2>Charts:</h2></div>

            <div id="exTab2" class="container">	
                <ul class="nav nav-tabs">
			        <li class="active">
                        <a  href="#1" data-toggle="tab">Tag trends  </a>
			        </li>
			        <li>
                        <a href="#2" data-toggle="tab">Device trends  </a>
			        </li>
		        </ul>

			    <div class="tab-content ">
			        <div class="tab-pane active" id="1">
                        <figure class="highcharts-figure">
                            <div id="pie"></div>
                        </figure>
				    </div>
				    <div class="tab-pane" id="2">
                        <figure class="highcharts-figure">
                            <div id="donut"></div>
                        </figure>
				    </div>
			    </div>
            </div>

            <div id="tooltip" class="tooltip">
                <div class="tooltip-range" id="range"></div>
                <div class="tooltip-examples" id="examples"></div>
                <div class="tooltip-value">
                    ...of <span id="count"></span> tasks
                </div>
                <div class="tooltip-bar-value">
                    <b><span id="tooltip-bar-value"></span>%</b>
                    of the work was done by developers
                </div>
                <div class="tooltip-bar">
                    <div class="tooltip-bar-fill" id="tooltip-bar-fill"></div>
                </div>
            </div>
        </div>


        <script>

            /* JavaScript goes here. */
            // globals used in graph
            var running = false;
            var timer;
            //var validTimeSteps = ["2007_12", "2008_01", "2008_02", "2008_03", "2008_04", "2008_05", "2008_06", "2008_07", "2008_08", "2008_09", "2008_10", "2008_11", "2008_12"]
            var validTimeSteps = ["2001_1", "2001_2", "2001_3", "2001_4", "2002_1", "2002_2", "2002_3", "2002_4", "2003_1", "2003_2", "2003_3", "2003_4", "2004_1", "2004_2", "2004_3", "2004_4", "2005_1", "2005_2", "2005_3", "2005_4", "2006_1", "2006_2", "2006_3", "2006_4", "2007_1", "2007_2", "2007_3", "2007_4", "2008_1", "2008_2", "2008_3", "2008_4", "2009_1", "2009_2"]
            var validYears = ["2001","2002","2003","2004","2005","2006","2007","2008","2009"];

            var mapdata = {};
            var popular_tags = true;


            var width_main = window.innerWidth -16
			
			var height_main = window.innerHeight -56

            var width = 0.6*width_main, height = 0.75*height_main;
			
            var width_side_panel = 0.2*width_main
            var current_position;

            $(document).ready(function() {
                $('a#button').click(function() {
                    $(this).toggleClass("down");
                    popular_tags = !popular_tags;
                });
            });

            // define the tooltip 
            // var tool_tip = d3.tip()
            //     .attr("class", "d3-tip")
            //     // if the mouse position is greater than 650 (~ Kentucky/Missouri), offset tooltip to the left instead of the right
            //     .offset(function() {if(current_position[0] > 650) {
  	        //             return [-20,-120] } 
  	        //         else { return [20,120]}
            //     })
            //     // input the title, and include the div
            //     .html(
  	        //         "<p>Opioid-involved deaths over time in</p><div id='tipDiv'></div>"
            //     );
            var tip = d3.tip()
                .attr("class", "d3-tip")
                .style("width", "780 px")
			    .offset([250, 0])
    	        .html(function(d)
			    {
                    // var x = +d.properties.value;
                    // x = x.toPrecision(2);
                    return "<strong>Country: &nbsp;</strong><span>" + d.properties.name + "<br></span>"
                        + "<strong>Most Popular Tag: &nbsp;</strong><span>" + d.properties.most_popular_tag + "<br></span>"
                        + "<strong>No. of users: &nbsp;</strong><span>" + d.properties.user_freq + "<br><br></span>"
                        + "<div style='display: inline-flex;'><div id='tipDiv'></div><div id='tipDiv2'></div></div>";
                });
            
            
            
            active = d3.select(null);
            var zoom = d3.zoom()            
            // no longer in d3 v4 - zoom initialises with zoomIdentity, so it's already at origin
            // .translate([0, 0]) 
            // .scale(1) 
            .scaleExtent([1, 8])
            .on("zoom", zoomed);
            var minDocCount = 0, quantiles = {};
            // projection definitions
            var projection = d3.geoMercator()
                .scale((width + 1) / 2 / Math.PI)
                .translate([width/2, height/2])
                .precision(.1);
            var path = d3.geoPath().projection(projection);
            // SVG related definitions

            var main_container = d3.select("#my_dataviz").append("svg").attr("id", "main_container")
                        .attr("height", height_main)    // set the height
                        .attr("width", width_main); 

            var svg = main_container.append("g")
                        .attr("height", height)    // set the height
                        .attr("width", width)
                        .attr("id", "map-container")
                        .attr("transform",
                            "translate(" + width_side_panel + "," + 0 + ")");
            var left_panel =  main_container.append("g")
                        .attr("height", height_main)    // set the height
                        .attr("width", width_side_panel)
                        .attr("id", "left_panel");
            var rightPanelOffset = width_main - width_side_panel
            var right_panel =  main_container.append("g")
                        .attr("height", height_main)    // set the height
                        .attr("width", width_side_panel)
                        .attr("id", "right_panel")
                        .attr("transform",
                            "translate(" + rightPanelOffset + "," + 0 + ")");
            
            left_panel
                .append("rect")
                .attr("id", "background-left")
                .style("fill", "gray")
                .attr("width", width_side_panel)
                .attr("height", height_main)
            right_panel
                .append("rect")
                .attr("id", "background-right")
                .style("fill", "gray")
                .attr("width", width_side_panel)
                .attr("height", height_main)

            svg.call(tip);
            
            svg.append("rect")
                .attr("class", "background")
                .attr("width", width)
                .attr("height", height)

                .on("click", reset);
            var g = svg.append("g");

            svg
                .call(zoom); // delete this line to disable free zooming

            var filter = svg.append('defs')
                .append('filter')
                .attr("height", 1)    // set the height
                .attr("width", 1)    // set the width
                .attr("x", 0)    
                .attr("y", 0)    
                .attr("id", 'gray-background')
            filter.append('feFlood')
                .attr('flood-color', '#f2f2f2')
                .attr('result', 'COLOR');
            filter.append('feMorphology')
                .attr('operator', 'dilate')
                .attr('radius', '.9')
                .attr('in', 'SourceAlpha')
                .attr('result', 'MORPHED');
            filter.append('feComposite')
                .attr('in', 'SourceGraphic')
                .attr('in2', 'MORPHED')
                .attr('result', 'COMP1');
            filter.append('feComposite')
                .attr('in', 'COMP1')
                .attr('in2', 'COLOR');

            


            /// getting json input from flask
            var countries_mock_data = {{countries_mock_data| tojson}}
            var world_countries = {{ world_countries | tojson}};
            /*
            /// ALL data from csv
            var csv_data_all = {{ csv_data | tojson}};

            /// Object for filtering
            var filterObjectMap = 
            {
                "date":"2008_11"
            }

            console.log(csv_data_all)
            filtered_data = _.filter(csv_data_all, filterObjectMap)
            console.log("filtered")
            console.log(filtered_data)
            */

            var allTags = []
            for(catInd in Object.keys(countries_mock_data.allCategories))

            var myColor = d3.scaleOrdinal().domain(countries_mock_data.allCategories)
                .range(['#ffff99', '#beaed4' , '#7fc97f', '#fdc086', '#f0027f', '#386cb0', '#D3D3D3']);
			// animal, citylife, nature, people, sports, unknown
			
            //console.log(countries_mock_data)
            current_date_ind = 0
            current_date = validTimeSteps[current_date_ind]
            current_year_data = countries_mock_data.timesteps[current_date]
            country_in_focus_1 = "WORLD"
            country_in_focus_2 = "WORLD"
            //console.log(current_year_data)
            

            draw(world_countries ,current_year_data)

            function get_most_popular(obj){
                maxTag = -10000
                tag = ""
                for(ind in Object.keys(obj)){
                    key = Object.keys(obj)[ind]
                    if(obj[key]>maxTag){
                        maxTag = obj[key]
                        tag = key
                    }
                }
                return tag
            }

            function draw(world, data) {

                    for(var idx=0; idx < data.country_data.buckets.length; idx++) {
                        var cCode = data.country_data.buckets[idx].key.toUpperCase();
                        var most_popular_tag = data.country_data.buckets[idx].most_popular_category;
                        var most_popular_taglist = data.country_data.buckets[idx].categories_sum;
                        var user_freq = data.country_data.buckets[idx].user_freq;
                        var device_data = data.country_data.buckets[idx].device_data;
                        var catTrend = data.country_data.buckets[idx].categories;
                        for(var wdx=0; wdx < world.objects.subunits.geometries.length; wdx++) {
                            var cName = world.objects.subunits.geometries[wdx].id.toUpperCase();
                            if (cCode === cName) {
                                //TODO is it really necessary to take the data for charts from the map data?? 
                                // can also get it from an external json file using the country id... 
                                world.objects.subunits.geometries[wdx].properties.most_popular_tag = most_popular_tag;
                                world.objects.subunits.geometries[wdx].properties.most_popular_5 = most_popular_taglist;
                                world.objects.subunits.geometries[wdx].properties.user_freq = user_freq;
                                world.objects.subunits.geometries[wdx].properties.device_data = device_data;
                                world.objects.subunits.geometries[wdx].properties.category_trend = catTrend;
                            }
                        }
                    }
                    var subunits = topojson.feature(world, world.objects.subunits);
                    subunits.features = subunits.features.filter(function(d){ return d.id !== "ATA"; });
                    minDocCount = d3.min(subunits.features, function(d){ return d.properties.most_popular_tag; });
                    var most_popular_tag = subunits.features.map(function(d){ return d.properties.most_popular_tag; });
                    most_popular_tag = most_popular_tag.filter(function(d){ return d; }).sort(d3.ascending);
                    //console.log('most_popular_tag',most_popular_tag);
                    quantiles['0.95'] = d3.quantile(most_popular_tag, '0.95');
                    var countries = g.selectAll('path.subunit')
                        .data(subunits.features).enter();

                    countries.insert('path', '.graticule')
                        .attr('class', function(d) { return 'subunit ca'+d.id; })
                        .attr('d', path)
                        .on('mouseover',mouseoverLegend).on('mouseout',mouseoutLegend)
                        .on('mouseenter',mouseenterFunction).on('mouseleave',mouseleaveFunction)
                        .on("click", clicked);
                    
                    countries.append('svg:text')
                        .attr('class', function(d){ return 'subunit-label la'+d.id+d.properties.name.replace(/[ \.#']+/g,''); })
                        //.attr('transform', function(d) { return 'translate('+ path.centroid(d) +')'; })
                        .attr('transform', function(d) { return 'translate('+(width-(5*d.properties.name.length))+','+(15)+')'; })
                        .attr('dy', '.35em')
                        .attr('filter', 'url(#gray-background)')
                        .append('svg:tspan')
                        .attr('x', 0)
                        .attr('dy', 0)
                        .text(function(d) { return d.properties.name; })
                        .append('svg:tspan')
                        .attr('x', 0)
                        .attr('dy', 20)
                        .text(function(d) { return d.properties.most_popular_tag ? d.properties.most_popular_tag : ''; });
                    
                    var toColor = g.selectAll(".subunit")

                    toColor            
                    .transition()
                    .duration(750)
                    .style("fill", heatColor)


                    // var upDatedData = {};
                    //     upDatedData.properties = {};
                    //     upDatedData.properties.device_data = {};
                    //     upDatedData.properties.most_popular_5 = {};
                    //     //TODO Have to change this logic, how to find out the key when sliding inside the countries..
                    //     // For now only world changes..
                    //     upDatedData.properties.device_data = data.country_data.buckets[0].device_data;
                    //     upDatedData.properties.most_popular_5 = data.country_data.buckets[0].most_popular_5;
                    //     refreshDonutDiv(upDatedData);
                    //     refreshPieDiv(upDatedData);
                    // console.log("data->",data)
             
            }

            function mouseenterFunction(datum, index) {
                // tip.style("left", d3.select(this).attr("cx") + "px")     
                //     .style("top", d3.select(this).attr("cy") + "px");
                tip.show(datum);
                if (popular_tags) {
                    refreshPie1(datum);
                    getTagPerCategories(datum);
                }
                else
                    refreshDonut1(datum);
            }

            function mouseleaveFunction(datum, index) {
                tip.hide();
            }
            

            function mouseoverLegend(datum, index) {
                var point = d3.mouse(this);
                current_position = point;
                d3.selectAll('.subunit-label.la'+datum.id+datum.properties.name.replace(/[ \.#']+/g,''))
                    .style('display', 'inline-block')
              
                d3.selectAll('.subunit.ca'+datum.id)
                    .style("fill", function() {
					return d3.rgb(d3.select(this).style("fill")).darker(0.5);
					});


                //tooltip.style("opacity", 1);
                //tooltip.style("transform", `translate(50px,50px)`)
                // tip.show(datum);
                // refreshDonut1(datum);
                // //TODO Need to add null checks..
                // var tip_country = datum.properties.name;
                // var tip_most_popular_tag = datum.properties.most_popular_tag;
                // var tip_user_freq = datum.properties.user_freq;


                // var tipSVG = d3.select("#tipDiv")
      			// 	.append("svg")
      			// 	.attr("width", 150)
                //     .attr("height", 20);

                
                      
            
                
            } 

            function mouseoutLegend(datum, index) {
                d3.selectAll('.subunit-label.la'+datum.id+datum.properties.name.replace(/[ \.#']+/g,''))
                    .style('display', 'none');
                d3.selectAll('.subunit.ca'+datum.id)
                    .style('fill', heatColor(datum));

                //tooltip.style("opacity", 0)
                //tip.hide();
            }


            function heatColor(d) {
                d_c = d.properties.most_popular_tag
                return d_c === null ? 'grey' :myColor(d_c);
            }
            /////////////////////////////////////////////////////// Zooming functions //////////////////////////////////////////////////////
            function clicked(d) {
                if (active.node() === this) return reset();
                active.classed("active", false);
                active = d3.select(this).classed("active", true);

                var bounds = path.bounds(d),
                    dx = bounds[1][0] - bounds[0][0],
                    dy = bounds[1][1] - bounds[0][1],
                    x = (bounds[0][0] + bounds[1][0]) / 2,
                    y = (bounds[0][1] + bounds[1][1]) / 2,
                    scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
                    translate = [width / 2 - scale * x, height / 2 - scale * y];
                svg.transition()
                    .duration(2000)
                    // .call(zoom.translate(translate).scale(scale).event); // not in d3 v4
                    .call( zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) ); // updated for d3 v4
                
                refreshDonutDiv(d);
                refreshPieDiv(d);

                refreshStreamGraph(d.id, current_selection_svg, validTimeSteps, width_stream, height_stream, "category", current_selection_ticks_enabled)
                refreshStreamGraph(d.id, svg_focused_stream, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                changeCurrentSelections(d.id)
                

            }

            function reset() {
                console.log("resetting")
                active.classed("active", false);
                active = d3.select(null);

                svg.transition()
                    .duration(750)
                    // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
                    .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4
                
                changeCurrentSelections("WORLD")
                refreshStreamGraph("WORLD", current_selection_svg, validTimeSteps, width_stream, height_stream, "category", current_selection_ticks_enabled)
                refreshStreamGraph("WORLD", svg_focused_stream, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
                //TODO have to add reset functionality for pie and donut..

            }

            function zoomed() {
                g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
                // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
                g.attr("transform", d3.event.transform); // updated for d3 v4
            }

            // If the drag behavior prevents the default click,
            // also stop propagation so we donâ€™t click-to-zoom.
            function stopped() {
                if (d3.event.defaultPrevented) d3.event.stopPropagation();
            }

            ///////////////////////////////////////////////// Play button functions /////////////////////////////////////////////////////////////////////
            // heat point test

            // add circles to svg
            /*
            g.selectAll("circle")
                .data(testpoints).enter()
                .append("circle")
                .attr("cx", function (d) { console.log(projection(d)); return projection(d)[0]; })
                .attr("cy", function (d) { return projection(d)[1]; })
                .attr("r", "5px")
                .attr("fill", "grey")
                .attr("fill-opacity","0.2")
            */
            
            
            $("#play").on("click", function() {
		
            var duration = 800,
                maxstep = validTimeSteps[validTimeSteps.length],
                minstep = validTimeSteps[0];
            
            if (running == true) {
            
                $("#play").html("Play");
                running = false;
                clearInterval(timer);
                
            } 
 
            else if (running == false) {
            
                $("#play").html("Pause");
                
                
                timer = setInterval( function(){
                        if (current_date != maxstep){
                            current_date_ind++;
                            current_date = validTimeSteps[current_date_ind]
                            current_year_data = countries_mock_data.timesteps[current_date]
              
                            draw(world_countries,current_year_data);
                            updateStreamSlider()
                        }else{
                            $("#play").html("Play");
                            running = false;
                            clearInterval(timer);
                        }
            
                    
                }, duration);
                running = true;
                
                
            }

        });
        ////////////////////////////////// StreamGraph ///////////////////////////////////////////////////////////////////////////////////////////////////
            
            var allCategoriesEmpyty = {
            }
            for(catInd in countries_mock_data.allCategories){
                allCategoriesEmpyty[countries_mock_data.allCategories[catInd]] = 0
            }
            var allTagsEmpyty = {}
            var reverseTagCatIndex = {}


            function getStreamData(country_key, timeSteps, level){


                var d = []
                var keys = new Set()
                var maxYear = 0

                if(level == "tag"){
                    reverseTagCatIndex = {}
                    allTagsEmpyty = {}
                    for(var timeStepInd in timeSteps){
                        var timeStep = timeSteps[timeStepInd]
                        var country_bucket = countries_mock_data.timesteps[timeStep].country_data.buckets.find( function (e){
                            return e.key == country_key
                        })
                        if(country_bucket){
                            var catList = Object.keys(country_bucket.categories)
                            for(catInd in catList){
                            var catObj = country_bucket.categories[catList[catInd]]
                    
                            if(catObj){
                                catTags = Object.keys(catObj.top_5)
                                for(catTagInd in catTags){
                                    allTagsEmpyty[catTags[catTagInd]] = 0
                                    
                                    reverseTagCatIndex[catTags[catTagInd]] = catList[catInd]
                           
                              
                            }
                            }
                            reverseTagCatIndex["other " + catList[catInd] + " tags"] = catList[catInd]
                        }
                        }

                        
                    }
                }
    
                var tags
                var year_count = 0
                for(var timeStepInd in timeSteps){
                    year_count = 0
                    var timeStep = timeSteps[timeStepInd]
                    var country_bucket = countries_mock_data.timesteps[timeStep].country_data.buckets.find( function (e){
                        return e.key == country_key
                    })
                    emptyObj = level == "tag"?allTagsEmpyty:allCategoriesEmpyty

                    var year_data = {"time_step_graph" : timeStep}
                    Object.assign(year_data, emptyObj);
                    if(country_bucket){
            
                        //var tags = Object.assign({}, country_bucket.most_popular_5, country_bucket.rest_tags)
                        tags = JSON.parse(JSON.stringify(country_bucket.categories_tags_sum))
              
                        tag_list = Object.keys(tags)

                  
                            
                            if(level == "category"){
                                for(var tagInd in tag_list){
                                    tag = tag_list[tagInd]
                                    year_count += tags[tag]
                                    year_data[tag] = tags[tag]
                                    keys.add(tag)
                                }
                            }else{
                
                                var allTagsList = {}
                                for(var tagInd in tag_list){
                                    cat = tag_list[tagInd]
                                    cat_obj = country_bucket.categories[cat]
                                    if(cat_obj){
                                        all_cat_tag_obj = cat_obj.all_tags
                                        allTagsList = Object.assign(allTagsList, all_cat_tag_obj)
                                    }
                               
                                }
                                var catTagList =Object.keys(emptyObj)
                    
                                for(var catInd in catTagList){
                        
                                    var catCount =  allTagsList[catTagList[catInd]]
                                    if(typeof catCount == "undefined"){
                                        catCount = 0
                                    }
                        
                                    year_data[catTagList[catInd]] = catCount
                                    keys.add(catTagList[catInd])
                                    tags[reverseTagCatIndex[catTagList[catInd]]] -= catCount
                                    year_count += catCount
                                
                                }
                                 
                        
        
                
                            // pushing untagged data into focused
                            for(var c in Object.keys(tags)){
                                var cat_untagged = Object.keys(tags)[c]
                                var other_tag = "other " + cat_untagged + " tags"
                                year_data[other_tag] = tags[cat_untagged]
                                year_count += tags[cat_untagged]
                                keys.add(other_tag)

                            }
                            
                        }
                    }
              
                    d.push(year_data)
                    if (year_count>maxYear){
                        maxYear = year_count
                    }
          

                }
                keys = Array.from(keys)


                return [d, maxYear, keys]
            }

    var margin = {top: 100, right: 20, bottom: 20, left: 20},
    width_stream = 800
    height_stream = 70

    


d3.select("#main_container")
    .append("g")
        .attr("width", width_stream + margin.left + margin.right)
        .attr("height", height_stream * 2.5 + margin.top + margin.bottom)
        .attr("id", "streamContainer")
        .attr("transform",
            "translate(" + width_side_panel + "," + 0 + ")")
    
    d3.select("#streamContainer")
        .append("rect")
        .attr("id", "background-stream")
        .style("fill", "red")
        .attr("width", width_stream + margin.left + margin.right)
        .attr("height", height_stream * 2.5 + margin.top + margin.bottom)
        .attr("transform",
            "translate(" + margin.left + "," + height + ")")

    svg_stream = d3.selectAll("#streamContainer")
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + height + ")")
        .attr("id", "stream_1");
    
    height_stream_2 = 70
    var offset_top_stream_2 = (height+margin.top)
    var svg_stream_2 = d3.selectAll("#streamContainer")
            .append("g")
            .attr("transform",
                    "translate(" + margin.left + "," + offset_top_stream_2 + ")")
            .attr("id", "stream_2");

    current_selection_svg = svg_stream
    current_selection_ticks_enabled = false
    
    function changeCurrentSelections(countryID){
        if(current_selection_svg == svg_stream){
            current_selection_svg = svg_stream_2
            svg_focused_stream = right_focus_g
            current_selection_ticks_enabled = true
            country_in_focus_1 = countryID
        }else{
            current_selection_svg = svg_stream
            svg_focused_stream = left_focus_g
            current_selection_ticks_enabled = false
            country_in_focus_2 = countryID
        }
    }


            /// adding variables and rect for the focused stream graph

    var focusMargin = 20
    var focusStremTartgetBottom = 0
    var focusStremTartgetLeft = focusMargin
    var focusStremTartgetRight = width_side_panel
    var focusStremTartgetTop =  200
    

    
    left_panel
            .append("rect")
            .attr('id', "rect-focus-left")
            .style("fill", "black")
            .attr("fill-opacity","0.1")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "black")
            .attr("width", focusStremTartgetRight - focusStremTartgetLeft)
            .attr("height", focusStremTartgetTop - focusStremTartgetBottom)
            .attr("x", focusStremTartgetLeft)
            .attr("y", focusStremTartgetBottom)

    right_panel
            .append("rect")
            .attr('id', "rect-focus-right")
            .style("fill", "black")
            .attr("fill-opacity","0.1")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "black")
            .attr("width", focusStremTartgetRight - focusStremTartgetLeft)
            .attr("height", focusStremTartgetTop - focusStremTartgetBottom)
            .attr("x", 0)
            .attr("y", focusStremTartgetBottom)
    
    var left_focus_g = d3.select("#left_panel")
        .append("g")
        .attr('id', "g-focus-left")
        .attr("transform",
            "translate(" + 38 + "," + 0 + ")");

    var right_focus_g = d3.select("#right_panel")
        .append("g")
        .attr('id', "g-focus-right")
        .attr("transform",
            "translate(" + 38 + "," + 0 + ")");

    var svg_focused_stream = left_focus_g
    var margin_focused = {top: 0, right: 0, bottom: 0, left: 0},
        width_stream_focused = 300
        height_stream_focused = 200



    function getX(validTimeSteps_x, width_stream_x){
        var x = d3.scaleOrdinal()
        var stramChartXRange = []
        var rangeStep = width_stream_x / validTimeSteps_x.length
        step = 0
        for(t in validTimeSteps_x){
            stramChartXRange.push(step)
            step += rangeStep
        }

        // Add X axis
        x
            .domain(validTimeSteps_x)
            .range(stramChartXRange);
        return x
    }

    var x_main_stream = getX(validTimeSteps, width_stream)

    function getY(maxRange, height_stream_y){
        var y = d3.scaleLinear()
        y
            .domain([0, maxRange])
            .range([ height_stream_y * 0.8, 20 ]);
        return y

    }
    var rectAdd = 10
    var rectWidthRightSteps = 2
    var rectWidthLeftSteps = 2
    var rectWidthRight =(width_stream / validTimeSteps.length) * rectWidthRightSteps
    var rectWidthLeft = (width_stream / validTimeSteps.length) * rectWidthLeftSteps
    var rectHeight = height_stream - 2/rectAdd


    let drag = d3.drag()
        .on('drag', dragged)
    let dragLeft = d3.drag()
        .on('drag', draggedLeft) 
    let dragRight = d3.drag()
        .on('drag', draggedRight)

    drawStreamGraph(country_in_focus_1, current_selection_svg, validTimeSteps, width_stream, height_stream, "category", ticksEnabled = current_selection_ticks_enabled)
    drawStreamGraph(country_in_focus_1, svg_stream_2, validTimeSteps, width_stream, height_stream, "category")

    drawStreamGraph(country_in_focus_1, left_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
    drawStreamGraph(country_in_focus_1, right_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")

    updateStreamSlider()

    function getFocusedValidSteps(){
        var start_index = Math.max(current_date_ind - rectWidthLeftSteps, 0)
        var end_index = Math.min(current_date_ind + rectWidthRightSteps, validTimeSteps.length)
        timesteps = []
        for(start_index; start_index<=end_index; start_index++){
            timesteps.push(validTimeSteps[start_index])
        }
        return timesteps
    }

    function invertX(xpos){
        var ypos = x_main_stream.domain()[d3.bisect(x_main_stream.range(), xpos) - 1];
        return ypos
    }

    function dragged(d) {
        current_date = invertX(d3.mouse(this)[0]-400)
        current_date_ind = validTimeSteps.findIndex((element) => element == current_date)
        updateStreamSlider()
    }

    function draggedLeft(d) {
        current_time_pos = x_main_stream(current_date)
        current_mouse_pos = d3.mouse(this)[0] - 400
        time_step_size = (width_stream / validTimeSteps.length)
        if(current_time_pos - current_mouse_pos > time_step_size * (rectWidthLeftSteps+1)){
            rectWidthLeftSteps = Math.min(rectWidthLeftSteps+1, current_date_ind )

            rectWidthLeft = time_step_size * rectWidthLeftSteps
            updateStreamSlider()
        }else if(current_time_pos - current_mouse_pos < time_step_size * (rectWidthLeftSteps-1)){
            rectWidthLeftSteps = Math.max(1, rectWidthLeftSteps-1)
            rectWidthLeft = time_step_size * rectWidthLeftSteps
            updateStreamSlider()
        }
    }

    function draggedRight(d) {
        current_time_pos = x_main_stream(current_date)
        current_mouse_pos = d3.mouse(this)[0] - 400
        time_step_size = (width_stream / validTimeSteps.length)
        if(current_mouse_pos - current_time_pos > time_step_size * (rectWidthRightSteps+1)){
            rectWidthRightSteps = Math.min(rectWidthRightSteps+1, validTimeSteps.length - current_date_ind - 1)
            rectWidthRight = time_step_size * rectWidthRightSteps
            updateStreamSlider()
        }else if(current_mouse_pos - current_time_pos < time_step_size * (rectWidthRightSteps-1)){
            rectWidthRightSteps = Math.max(1, rectWidthRightSteps-1)
            rectWidthRight = time_step_size * rectWidthRightSteps
            updateStreamSlider()
        }
    }

    /// define area and axes for the main stream graph

    function addHexColor(c1, c2) {
        var hexStr = (parseInt(c1, 16) + parseInt(c2, 16)).toString(16);
        while (hexStr.length < 6) { hexStr = '0' + hexStr; } // Zero pad.
        return hexStr;
        }

    function getRandomGrey(){
        r = Math.random()/5
        return d3.interpolateGreys(r)
    }

    function drawStreamGraph(country_key, svg_stream, validTimeSteps_graph, width_stream_graph, height_stream_graph, level, ticksEnabled = true){
// append the svg object to the body of the page

        //svg_stream.selectAll("path").remove()


        // Parse the Data
        var [data, yRange, keys] = getStreamData(country_key, validTimeSteps_graph, level)

        var x = getX(validTimeSteps_graph, width_stream_graph)
        var y = getY(yRange, height_stream_graph)
        if(ticksEnabled){
            svg_stream.append("g")
            .attr("transform", "translate(0," + height_stream_graph*0.8 + ")")
            .call(d3.axisBottom(x).tickSize(-height_stream_graph*.7)
			.tickValues(validTimeSteps_graph)
			.tickFormat(function(d, i){
			    var year = d.substring(0,4);
				if (!(i % 4)) return year;
			})
			)
            .select(".domain").remove()
        // Customization
        svg_stream.selectAll(".tick line")
        .attr("stroke", "grey")
        if(level == "category"){
            svg_stream.selectAll(".tick line")
            .attr("stroke-opacity", 0);
        }

        // Add X axis label:
        svg_stream.append("text")
            .attr("text-anchor", "end")
            .attr("x", width_stream_graph-25)
            .attr("y", height_stream_graph-30 )
			.attr('font-size', 12)
            .text("Year");
        }



        // Add Y axis

        //stack the data?
        var stackedData = d3.stack()
            //.offset(d3.stackOffsetSilhouette)
            .keys(keys)
            (data)

        // create a tooltip
        var Tooltip = svg_stream
            .append("text")
            .attr("id", "stream-tooltip")
            .attr("x", 0)
            .attr("y", 20)
            .style("opacity", 0)
            .style("font-size", 17)

        // Three function that change the tooltip when user hover / move / leave a cell
        var mouseover = function(d) {
            Tooltip.style("opacity", 1)
            d3.selectAll(".myArea-" + level ).style("opacity", .2)
            d3.select(this)
            .style("stroke", "black")
            .style("opacity", 1)
        }
        var mousemove = function(d,i) {
            grp = d.key
            Tooltip.text(grp)
 
        }
        var mouseleave = function(d) {
            Tooltip.style("opacity", 0)
            d3.selectAll(".myArea-" + level ).style("opacity", 1)
            d3.selectAll(".myArea-category" ).style("stroke", "none")
        }

        var clickedStream = function(d){
            current_date = invertX(d3.mouse(this)[0])
            current_date_ind = validTimeSteps_graph.findIndex((element) => element == current_date)
            updateStreamSlider()
        }
        var logged = false
        // Area generator
        var area = d3.area()
            .x(function(d) {return x(d.data.time_step_graph); })
            .y0(function(d) {return y(d[0]); })
            .y1(function(d) { return y(d[1]); })
        

        // Show the areas
        svg_stream
            .selectAll("mylayers")
            .data(stackedData)
            .enter()

            .append("path")
            .attr("id", "path" + level)
            
            .attr("class", "myArea-" + level )
            .style("fill", function(d) { return d.key === null ? 'grey' : myColor(d.key); })
            .attr("d", area)
            
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
            .on("click", clickedStream);


    }

    function refreshStreamGraph(country_key, svg_stream, validTimeSteps_graph, width_stream_graph, height_stream_graph, level, ticksEnabled = true){
        svg_stream.selectAll(".tick").remove()

        // Parse the Data
    

        var [data, yRange, keys] = getStreamData(country_key, validTimeSteps_graph, level)
        var x = getX(validTimeSteps_graph, width_stream_graph)
        var y = getY(yRange, height_stream_graph)


        // List of groups = header of the csv files
        if(ticksEnabled){
            svg_stream.append("g")
            .attr("transform", "translate(0," + height_stream_graph*0.8 + ")")
            .call(d3.axisBottom(x)
			.tickSize(-height_stream_graph*.7)
			.tickValues(validTimeSteps_graph)
			.tickFormat(function(d, i){
			    var year = d.substring(0,4);
				var month = d.substring(5, 7);
				if (d.substring(5,6) === '1'){
					return year;			
				}
			})
			)
			
            .select(".domain").remove()
        // Customization
        svg_stream.selectAll(".tick line")
        .attr("stroke", "grey")
        if(level == "category"){
            svg_stream.selectAll(".tick line")
            .attr("stroke-opacity", 0);
        }
        }



        //stack the data?
        var stackedData = d3.stack()
            //.offset(d3.stackOffsetSilhouette)
            .keys(keys)
            (data)

        // Area generator
        var area = d3.area()
            .x(function(d) { return x(d.data.time_step_graph); })
            .y0(function(d) { return y(d[0]); })
            .y1(function(d) { return y(d[1]); })

        // create a tooltip
        var Tooltip = svg_stream
            .append("text")
            .attr("x", 0)
            .attr("y", 20)
            .style("opacity", 0)
            .style("font-size", 17)
        
        var mouseover = function(d) {
            Tooltip.style("opacity", 1)
            d3.selectAll(".myArea-" + level ).style("opacity", .2)
            d3.select(this)
            .style("opacity", 1)
                d3.selectAll(".myArea-" + level )            
                .style("stroke", "black")

                 
        }
        var mousemove = function(d,i) {
            grp = d.key
            Tooltip.text(grp)
 
        }
        var mouseleave = function(d) {
            Tooltip.style("opacity", 0)
            d3.selectAll(".myArea-" + level ).style("opacity", 1)
            d3.selectAll(".myArea-category" ).style("stroke", "none")
            
            
        }

        var clickedStream = function(d){
            current_date = invertX(d3.mouse(this)[0])
            current_date_ind = validTimeSteps_graph.findIndex((element) => element == current_date)
            updateStreamSlider()
        }


        var country_paths = svg_stream.selectAll("#path" + level)
            .data(stackedData)
        country_paths
            .enter()
            .append("path")
   
            .style("fill", function(d, i) { 
        
                if(!d){
                    return 'grey'
                }else if(level == "tag"){
                    return myColor(reverseTagCatIndex[d.key]) 
                }else{
                    return myColor(d.key)
                }
            })
            
            .attr("d", area)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
            .on("click", clickedStream);



        country_paths.exit().remove()

   
        d3.selectAll(".myArea-tag" )            
                .style("stroke", "black")
                .attr('stroke-width', .2)


    }



    function updateStreamSlider(){
        var rectGrabBottom = height 
        var rectGrabTop = height - height_stream_2 - height_stream
        var focusRectCornerTop = height + height_stream + 15
        var focusRectCornerRight = x_main_stream(current_date) + (rectWidthRight)
        var focusRectCornerLeft = x_main_stream(current_date) - (rectWidthLeft)
        d3.select("#sliderG").remove()
        d3.selectAll("#line-focus").remove()


        var sliderG = d3.select("#streamContainer").append("g").attr("id", "sliderG")
        .attr("transform",
            "translate(" + 20 + "," + 150 + ")");

        sliderG
            .append("line")
            .attr('id', "line-comparison")
            .attr('stroke', 'black')
            .attr('stroke-width', 2)
            .attr('x1', x_main_stream(current_date))
            .attr('y1', rectGrabBottom + rectAdd)
            .attr('x2', x_main_stream(current_date))
            .attr('y2', rectGrabTop)
            .call(drag);

        sliderG
            .append("line")
            .attr('id', "line-split")
            .attr('stroke', 'black')
            .attr('stroke-width', 0.5)
            .attr('x1', focusRectCornerLeft)
            .attr('y1', height - height_stream + 5)
            .attr('x2', focusRectCornerRight)
            .attr('y2', height - height_stream + 5 )
        sliderG
            .append("rect")
            .attr('id', "rect-grab")
            .style("fill", "black")
            .attr("fill-opacity","0.05")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "black")
            .attr("width", focusRectCornerRight - focusRectCornerLeft)
            .attr("height",  rectGrabBottom - rectGrabTop + rectAdd)
            .attr("x", focusRectCornerLeft)
            .attr("y", rectGrabTop)
            .call(drag);

        /// magnifying lines to left
        main_container
            .append("line")
            .attr('id', "line-focus")
            .attr('stroke', '#E3E3E3')
            .attr('stroke-width', 2)
            .style("stroke-dasharray", ("3, 3"))
            .attr('x1', focusRectCornerLeft + width_side_panel + margin.left)
            .attr('y1', focusRectCornerTop)
            .attr('x2', focusStremTartgetLeft)
            .attr('y2', focusStremTartgetTop)
            .call(drag);
        main_container
            .append("line")
            .attr('id', "line-focus")
            .attr('stroke', '#E3E3E3')
            .attr('stroke-width', 2)
            .style("stroke-dasharray", ("3, 3"))
            .attr('x1', focusRectCornerRight + width_side_panel + margin.left)
            .attr('y1', focusRectCornerTop)
            .attr('x2', focusStremTartgetRight)
            .attr('y2', focusStremTartgetTop)
            .call(drag);

        /// magnifying lines to right
        main_container
            .append("line")
            .attr('id', "line-focus")
            .attr('stroke', '#E3E3E3')
            .attr('stroke-width', 2)
            .style("stroke-dasharray", ("3, 3"))
            .attr('x1', focusRectCornerLeft + width_side_panel + margin.left)
            .attr('y1', focusRectCornerTop + height_stream)
            .attr('x2', focusStremTartgetLeft + width + width_side_panel - focusMargin)
            .attr('y2', focusStremTartgetTop)
            .call(drag);
        main_container
            .append("line")
            .attr('id', "line-focus")
            .attr('stroke', '#E3E3E3')
            .attr('stroke-width', 2)
            .style("stroke-dasharray", ("3, 3"))
            .attr('x1', focusRectCornerRight + width_side_panel + margin.left)
            .attr('y1', focusRectCornerTop+ height_stream)
            .attr('x2', focusStremTartgetRight  + width + width_side_panel- focusMargin)
            .attr('y2', focusStremTartgetTop)
            .call(drag);

        /// add draggable rect to adjust size of focus window
        sliderG
            .append("rect")
            .attr('id', "focus-grab")
            .style("fill", "black")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "black")
            .attr("width",10)
            .attr("height", 10)
            .attr("x", focusRectCornerLeft-5)
            .attr("y", rectGrabBottom )
            .call(dragLeft);
        sliderG
            .append("rect")
            .attr('id', "focus-grab")
            .style("fill", "black")
            .attr("rx", 3)
            .attr("ry", 3)
            .style("stroke", "black")
            .attr("width", 10)
            .attr("height", 10)
            .attr("x", focusRectCornerRight-5)
            .attr("y", rectGrabBottom )
            .call(dragRight);

        //calling update on map
        current_year_data = countries_mock_data.timesteps[current_date]
        draw(world_countries ,current_year_data)
        
        refreshStreamGraph(country_in_focus_1, left_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
        refreshStreamGraph(country_in_focus_2, right_focus_g, getFocusedValidSteps(), width_stream_focused, height_stream_focused, "tag")
          
    }




    //Donut chart 1 ...

function convertToDonut1(datum) {
 var fdata = {};
 var categories = [];
 var data = [];
 var device_data = datum.properties.device_data;
 for (var key in device_data) {
 	categories.push(key);
 }
 var colors = Highcharts.getOptions().colors;

  var typeData = [];
  var deviceData = [];
  var i;
  var j;
  var dataLen = categories.length;
  var drillDataLen;
  var brightness;
 for (i = 0; i < dataLen; i += 1) {

    // add type data
    typeData.push({
        name: categories[i],
        y: device_data[categories[i]].total,  //data[i].y,
        color: colors[i] //data[i].color
    });

    // add device data 
    drillDataLen = device_data[categories[i]].length - 1 //data[i].drilldown.data.length;
    if (categories[i] == "others") {
    	drillDataLen += 1;
    }
    for (var keys2 in device_data[categories[i]]) {
    	if (keys2 != 'total' || categories[i] == "others"){
      	        brightness = 0.2 - (j / drillDataLen) / 5;
        deviceData.push({
            name: keys2, //device_data[categories[i]][j],
            y: device_data[categories[i]][keys2], //data[i].drilldown.data[j],
            color: Highcharts.color(colors[i]).brighten(brightness).get()
        });
      }
    }
}
var retData = {};
retData.typeData = typeData;
retData.deviceData = deviceData;
return retData;
}


function refreshDonut1(dat){

var donut1data = convertToDonut1(dat);


// Create the chart
Highcharts.chart('tipDiv', {
    chart: {
        type: 'pie'
    },
    title: {
        text: 'Device usage trend'
    },
    subtitle: {
        text: 'Source: Flickr dataset'
    },
    credits: {
        enabled: false
    },
    plotOptions: {
        pie: {
            shadow: false,
            center: ['50%', '50%']
        }
    },
    tooltip: {
        valueSuffix: '%'
    },
    series: [{
        name: 'Device',
        data: donut1data.typeData,
        size: '60%',
        dataLabels: {
            formatter: function () {
                return this.y > 5 ? this.point.name : null;
            },
            color: '#ffffff',
            distance: -30
        }
    }, {
        name: 'Models',
        data: donut1data.deviceData,
        size: '80%',
        innerSize: '60%',
        dataLabels: {
            formatter: function () {
                // display only if larger than 1
                return this.y > 1 ? '<b>' + this.point.name + ':</b> ' +
                    this.y + '' : null;
            }
        },
        id: 'versions'
    }],
    responsive: {
        rules: [{
            condition: {
                maxWidth: 400
            },
            chartOptions: {
                series: [{
                }, {
                    id: 'versions',
                    dataLabels: {
                        enabled: false
                    }
                }]
            }
        }]
    }
});


}


function refreshDonutDiv(dat){

var donut1data = convertToDonut1(dat);


// Create the chart
Highcharts.chart('donut', {
chart: {
    type: 'pie'
},
title: {
    text: 'Device usage trend'
},
subtitle: {
    text: 'Source: Flickr dataset'
},
credits: {
    enabled: false
},
plotOptions: {
    pie: {
        shadow: false,
        center: ['50%', '50%']
    }
},
tooltip: {
    valueSuffix: '%'
},
series: [{
    name: 'Device',
    data: donut1data.typeData,
    size: '60%',
    dataLabels: {
        formatter: function () {
            return this.y > 5 ? this.point.name : null;
        },
        color: '#ffffff',
        distance: -30
    }
}, {
    name: 'Models',
    data: donut1data.deviceData,
    size: '80%',
    innerSize: '60%',
    dataLabels: {
        formatter: function () {
            // display only if larger than 1
            return this.y > 1 ? '<b>' + this.point.name + ':</b> ' +
                this.y + '' : null;
        }
    },
    id: 'versions'
}],
responsive: {
    rules: [{
        condition: {
            maxWidth: 400
        },
        chartOptions: {
            series: [{
            }, {
                id: 'versions',
                dataLabels: {
                    enabled: false
                }
            }]
        }
    }]
}
});


}

function refreshPie1(dat) {
    var newDat = [];
    var colors = [];
var chkData = dat.properties.most_popular_5;
for (var key in chkData) {
	var obj = {};
  obj.name = key;
  obj.y = chkData[key];
  newDat.push(obj);
  colors.push(myColor(key));
}

Highcharts.chart('tipDiv', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie'
    },
    title: {
        text: 'Top 5 category trends'
    },
    credits: {
        enabled: false
    },
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %'
            },
            showInLegend: true,
            animation: false
        }
    },
    series: [{
        name: 'Flickr Tags',
        colorByPoint: true,
        colors: colors,
        data: newDat
    }],
    exporting: {
        enabled: false
    }
});
}

function refreshPieDiv(dat) {
    var newDat = [];
    var colors = [];
var chkData = dat.properties.most_popular_5;
for (var key in chkData) {
	var obj = {};
  obj.name = key;
  obj.y = chkData[key];
  newDat.push(obj);
  colors.push(myColor(key));
}

Highcharts.chart('pie', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie'
    },
    title: {
        text: 'Top 5 category trends'
    },
    credits: {
        enabled: false
    },
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %'
            },
            showInLegend: true
        }
    },
    series: [{
        name: 'Flickr Tags',
        colorByPoint: true,
        colors: colors,
        data: newDat
    }]
});
}


function getTagPerCategories(dat) {

    catArray = [];
    var tempData = dat.properties.most_popular_5;
    var map = [];
    var i=0;
    for (var key in tempData) {
        if (key != 'unknown' && tempData[key] != 0) {
            catArray.push(key);
            map[key] = i++;
        }
    }
    var seriesData = [];
    var categoryData = dat.properties.category_trend;
    var tagMap = [];
    for (var cat in catArray) {
        var catTags = categoryData[catArray[cat]].top_5;
        for (var tags in catTags) {
            if (tagMap[tags] == null) {
                //First Time..
                tagMap[tags] = Array(catArray.length).fill(0);
                tagMap[tags][map[catArray[cat]]] = catTags[tags];
            } 
            else {
                tagMap[tags][map[catArray[cat]]] = catTags[tags];
            }
        }
    }



    for (var key in tagMap){
        var obj = {};
        obj.name = key;
        obj.data = tagMap[key];
        seriesData.push(obj);
    }

    
    Highcharts.chart('tipDiv2', {
    chart: {
        type: 'column'
    },
    title: {
        text: 'Tag Per Category Trends'
    },
    xAxis: {
        categories: catArray
    },
    yAxis: {
        min: 0,
        // title: {
        //     text: 'Total fruit consumpti'
        // },
        stackLabels: {
            enabled: true,
            style: {
                fontWeight: 'bold',
                color: ( // theme
                    Highcharts.defaultOptions.title.style &&
                    Highcharts.defaultOptions.title.style.color
                ) || 'gray'
            }
        }
    },
    credits: {
        enabled: false
    },
    legend: {
        align: 'right',
        x: -30,
        verticalAlign: 'top',
        y: 25,
        floating: true,
        backgroundColor:
            Highcharts.defaultOptions.legend.backgroundColor || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
    },
    tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
        column: {
            stacking: 'normal',
            dataLabels: {
                enabled: true
            },
            animation: false
        }
    },
    series: seriesData,
    exporting: {
        enabled: false
    }
});
}





var randomColor = (function(){
  var golden_ratio_conjugate = 0.618033988749895;
  var h = Math.random();

  var hslToRgb = function (h, s, l){
      var r, g, b;

      if(s == 0){
          r = g = b = l; // achromatic
      }else{
          function hue2rgb(p, q, t){
              if(t < 0) t += 1;
              if(t > 1) t -= 1;
              if(t < 1/6) return p + (q - p) * 6 * t;
              if(t < 1/2) return q;
              if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
              return p;
          }

          var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          var p = 2 * l - q;
          r = hue2rgb(p, q, h + 1/3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1/3);
      }

      return '#'+Math.round(r * 255).toString(16)+Math.round(g * 255).toString(16)+Math.round(b * 255).toString(16);
  };
  
  return function(){
    h += golden_ratio_conjugate;
    h %= 1;
    return hslToRgb(h, 0.5, 0.60);
  };
})();







var sampleData = [{
            noOfDevices: 25,
            name: "2001",
            drilldown: [{
                noOfDevices: 15,
                name: "2001_01",
                drilldown: [{
                    noOfDevices: 10,
                    name: "camera",
                    drilldown: [{
                        noOfDevices: 5,
                        name: "Canon",
                        drilldown: []
                    }, {
                        noOfDevices: 5,
                        name: "Nikon",
                        drilldown: []
                    }]
                }, {
                    noOfDevices: 5,
                    name: "phone",
                    drilldown: [{
                        noOfDevices: 5,
                        name: "FujiFilm",
                        drilldown: []
                    }]
                }]
            }, {
                noOfDevices: 10,
                name: "2001_02",
                drilldown: [{
                    noOfDevices: 8,
                    name: "camera",
                    drilldown: [{
                        noOfDevices: 8,
                        name: "Nikon",
                        drilldown: []
                    }]
                }, {
                    noOfDevices: 2,
                    name: "others",
                    drilldown: [{
                        noOfDevices: 2,
                        name: "others",
                        drilldown: []
                    }]
                }]
            }]
        },
        {
            noOfDevices: 25,
            name: "2002",
            drilldown: [{
                noOfDevices: 15,
                name: "2002_01",
                drilldown: [{
                    noOfDevices: 10,
                    name: "camera",
                    drilldown: [{
                        noOfDevices: 5,
                        name: "Canon",
                        drilldown: []
                    }, {
                        noOfDevices: 5,
                        name: "Nikon",
                        drilldown: []
                    }]
                }, {
                    noOfDevices: 5,
                    name: "phone",
                    drilldown: [{
                        noOfDevices: 5,
                        name: "FujiFilm",
                        drilldown: []
                    }]
                }]
            }, {
                noOfDevices: 10,
                name: "2002_02",
                drilldown: [{
                    noOfDevices: 8,
                    name: "camera",
                    drilldown: [{
                        noOfDevices: 8,
                        name: "Nikon",
                        drilldown: []
                    }]
                }, {
                    noOfDevices: 2,
                    name: "others",
                    drilldown: [{
                        noOfDevices: 2,
                        name: "others",
                        drilldown: []
                    }]
                }]
            }]
        },
        {
            noOfDevices: 25,
            name: "2003",
            drilldown: [{
                noOfDevices: 15,
                name: "2003_01",
                drilldown: [{
                    noOfDevices: 10,
                    name: "camera",
                    drilldown: [{
                        noOfDevices: 5,
                        name: "Canon",
                        drilldown: []
                    }, {
                        noOfDevices: 5,
                        name: "Nikon",
                        drilldown: []
                    }]
                }, {
                    noOfDevices: 5,
                    name: "phone",
                    drilldown: [{
                        noOfDevices: 5,
                        name: "FujiFilm",
                        drilldown: []
                    }]
                }]
            }, {
                noOfDevices: 10,
                name: "2003_02",
                drilldown: [{
                    noOfDevices: 8,
                    name: "camera",
                    drilldown: [{
                        noOfDevices: 8,
                        name: "Nikon",
                        drilldown: []
                    }]
                }, {
                    noOfDevices: 2,
                    name: "others",
                    drilldown: [{
                        noOfDevices: 2,
                        name: "others",
                        drilldown: []
                    }]
                }]
            }]
        }];

        var config = {
            containerId: "chartContainer",
            width: 500,
            height: 500,
            data: sampleData,
            heading: {
                text: "Device trends",
                pos: "top"
            },
            label: function(d) {
                return d.data.name + ":" + d.data.noOfDevices;
            },
            value: "noOfDevices",
            inner: "drilldown",
            tooltip: function(d) {
                return "<div style='background-color: #4a4; color: white; padding: 15px; text-align: middle; border: dotted 1px black;'><strong>" + d.name + "</strong> has " + d.noOfDevices + " Devices used.</div>";
            },
            transition: "linear",
            transitionDuration: 100,
            donutRadius: 50,
            gradient: true,
            colors: randomColor,
            labelColor: "white",
            stroke: "#eee",
            strokeWidth: 3,
            drilldownTransition: "linear",
            drilldownTransitionDuration: 0,
            highlightColor: "#c00"
        };

        var samplePie = new multidonut.Pie(config);


        

    </script>

        
    </body>
    {% endblock %}